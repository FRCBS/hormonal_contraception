---
title: "DAG for anemia in FinOCC"
author: "Mikko Arvas"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DiagrammeR)
library(ggdag)
library(causaleffect)
library(igraph)
library(tidyverse)
library(dagitty)
library(ggdag)
library(tidygraph)
```

TODO:


-what do we do with age and time ? Can we break loops with some timing?

  
  -if we consider only women with out kids does age matter for inflammatory status, choise of HC or something else ?
  
  
  - Eeva said
  
    -younger are more likely to get combination pills, they can used to treat acne and menstrual disorders and combination pill raise risk of venous thromboembolism
  
    -for progestine pills age should not matter
    
    -> so there is age affect but also possibly the age effect depends on the hc type
    
  -how about how long a product has been used? the longer you have used it the more time it has had to have an effect? and this also is dependent on age. Could Muriel give me some pointers on how to address it? Could it be a percentage of age or is an interaction better as the estimate really don't matter? Do we have the dates of when the products were ordered? Or should we do a survival analysis?
  
-should we add a propensity score analysis with a score on how likely one is to use HC

-trial emulation?

# Functions

```{r}
from_ggdag_2_diagrammer <- function(ggdag.object) {
  tmp <- tidy_dagitty(ggdag.object)$data
 #tmp <- tidy_dagitty(anemia_dag)$data
  edges <- tmp %>% 
    select(name, to) %>% 
    rename("from"="name") %>% 
    na.omit()
  
   nodes <- tmp %>% 
   select(name,label) %>%
   #  select(name) %>% 
   rename("id"="name") %>%
   distinct() %>%
   na.omit()
  g <- create_graph(
    directed = TRUE,
    attr_theme = "tb"
  )
  g<- add_nodes_from_table(g,
                           table = nodes,
                           label_col = label)
  g <- add_edges_from_table(graph =g,
                            table=edges,
                            from_col = from,
                            to_col = to,
                            from_to_map=id_external)
  invisible(g)
}

```


```{r}
from_ggdag_2_igraph <- function(dagify.object) {
  tmp <- tidy_dagitty(dagify.object)$data
  tmp <- tmp %>% select(name, to) %>% 
  as.matrix() %>% # igraph wants a matrix
  na.omit() #there was A -> NA , maybe to spesify outcome
  tmp <- graph_from_edgelist(tmp, directed = TRUE)
  invisible(tmp)
}

```


# Pastricha DAG with hormonal contraception

Based on "Iron deficiency" 
Sant-Rayn Pasricha, Jason Tye-Din, Martina U Muckenthaler, Dorine W Swinkels 2021 Lancet
http://dx.doi.org/10.1016/S0140-6736(20)32594-0

```{r}

pastricha_dag <- ggdag::dagify(
  II ~ VD, # Low haem iron content (eg, from a vegetarian or vegan diet)
  II ~ ConInh, # Concomitant consumption of inhibitors of iron absorption (eg, calcium or tea)
  II ~ InAcid, # Inadequate acidification
  II ~ InMyc, # Intestinal mycosal dysfunction
  IS ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
  A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  IS ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  IS ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  IS ~ BD,
  IS ~ Cb,
  Cb ~ Pre,
  
  
  
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "HC" = 'Use/Choise\nof HC',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
   "Erosion" = "Erosion",
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet'
   
  ),
  exposure = "HC",
  outcome = "A"
)

pastricha_dag.diag <- from_ggdag_2_diagrammer(pastricha_dag)
render_graph(
  pastricha_dag.diag, 
#  layout="tree"
)
```

```{r}
latents(pastricha_dag) <- c("II","IS")
exposures(pastricha_dag) <- c("HC")
outcomes(pastricha_dag) <- c("A")

```


```{r}
ggdag_adjustment_set(pastricha_dag)
#how to define the latent variables to get the corract adjustement set
```

‘Backdoor Paths Unconditionally Closed’ means that, assuming the DAG we have drawn is correct, we may obtain an unbiased estimate of X on Y without including additional variables.

```{r}
ggdag_instrumental(pastricha_dag)
```

# Mindmap of factors related to iron deficiency anemia

Here we draw a mindmap with the intent of visualizing factors related to iron deficiency anemia (IDA) in Finnish premenopausal women. Although the the mindmap is drawn using the same code for drawing the final DAG, it does not fulfill the criteria for DAGs (for example, this one includes loops) and should not be used for analysis. 

Sources:

- IDA endpoint in FinRegistry (search term D3_ANAEMIA_IRONDEF), list of relationships between endpoints. Pathologies unlikely in premenopausal women or very uncommon not included in this mindmap. "In FinRegistry we include all the individuals that lived in Finland and were alive on the 1st of January 2010 as well as their parents, spouses, children, and siblings. The research data will be updated until 2025. You can explore disease endpoints at risteys.finregistry.fi."
- VTE associated with IDA not only through FinRegistry, but there is also evidence elsewhere:
* 1) Association between venous thromboembolism and iron-deficiency anemia : a population-based study, Hung et al. 2015, Blood Coagulation & Fibrinolysis, doi: 10.1097/MBC.0000000000000249. "The most reasonable explanation for the relationship between IDA and VTE is possibly secondary thrombocytosis that results from an iron deficiency . It is known that thrombocytosis frequently accompanies less-severe anemia of iron deficiency and may be related to platelet stimulation in a manner analogous to the increase in erythropoietin seen in many anemic states . Some researchers stated that an iron deficiency status is considered a risk factor for thrombocytosis and should, wherever possible, be avoided . Although the influence of secondary thrombocytosis on the development of a VTE appears to be quite rational, researchers have argued that this view might be an oversimplification, as some other studies showed decreased platelet aggregation in patients with an iron deficiency, and isovolemic hemodilution leads to a shortening of the reaction and coagulation times in a hematocrit-dependent manner. Another possible explanation is that the increase in plasminogen activator inhibitor-1 in anemia may cause decreased fibrinolytic activity in IDA . This mechanism is supported by evidence that the plasminogen activator inhibitor-1 was markedly increased in a case reported by Bukharovich et al. . In a recent study by Livesey et al. , those authors found that in patients with hereditary hemorrhagic telangiectasia, low serum iron levels were associated with elevated plasma levels of coagulation factor VIII and a venous thromboembolic risk . Although the mechanism for iron loss in those patients was attributed to inadequate replacement of hemorrhagic iron losses, with a similar iron deficiency status, patients with IDA might also be associated with an increased risk for a VTE. Finally, it is also possible that the increased sheer force caused by an anemia-induced hyperdynamic state can result in endothelial injuries and subsequent thrombus formation."
* 2) Association between Iron Deficiency Anemia and Thrombosis, a Population Based Study Laber et al 2023 Blood, https://doi.org/10.1182/blood-2023-190934 (for second one only abstract available)
- Factors influencing contraception choice and use globally: a synthesis of systematic reviews by D’Souza et al. 2022 (https://doi.org/10.1080/13625187.2022.2096215)
"We found 24 systematic reviews of mostly moderate or high quality. Factors affecting contraception use are remarkably similar among women in very different cultures and settings globally. Use of contraception is influenced by the perceived likelihood and appeal of pregnancy, and relationship status. It is influenced by women’s knowledge, beliefs, and perceptions of side effects and health risks. Male partners have a strong influence, as do peers’ views and experiences, and families’ expectations. Lack of education and poverty is linked with low contraception use, and social and cultural norms influence contraception and expectations of family size and timing. Contraception use also depends upon their availability, the accessibility, confidentiality and costs of health services, and attitudes, behaviour and skills of health practitioners."
- Factors associated with iron deficiency and how they can be used in blood donor selection processes (Sofie Ekroos, Mikko Arvas, Johanna Castrén, https://doi.org/10.1101/2022.02.01.22270122)
- https://www.uptodate.com/contents/causes-and-diagnosis-of-iron-deficiency-and-iron-deficiency-anemia-in-adults 

```{r}

pastricha_dag_mens <- ggdag::dagify(
  II ~ VD, # Low haem iron content (eg, from a vegetarian or vegan diet)
  II ~ ConInh, # Concomitant consumption of inhibitors of iron absorption (eg, calcium or tea)
  II ~ InAcid, # Inadequate acidification
  II ~ InMyc, # Intestinal mycosal dysfunction
  VD ~ Edu, # education level is associated with diet, such as vegan diet low in heam iron
  Inc ~ Edu, # education level is associated with income
  Res ~ Inc, # place of residence is associated with income level
  HC ~ Inc, # income affects ability to purchase HC
  IS ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  IS ~ IID, # increased iron demand can cause body iron stores to be depleted, if iron intake is inadequate
  IID ~ Exe, # exercise causes iron demand
  IID ~ Lac, # lactation increases iron demand
  IID ~ Pre, # pregnancy increases iron demand
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
  A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  IS ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  IS ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  InLoss ~ IBD, # IBD causes GI blood loss
  Iinfl ~ IBD, # IBD causes inflammation
  Iinfl ~ Ob,
  InMyc ~ IBD, # IBD causes intestinal dysfunction (through inflammation?)
  InMyc ~ GBP, # gastric bypass, particularly Roux-en-Y, causes food to bypass duodenum.  
  InMyc ~ CD, # celiac disease
  InMyc ~ HP, # H. Pylori
  IS ~ BD, # Blood donation can cause iron deficiency
  BD ~ IS, # If you are low own iron you can't get to donate 
  IS ~ Cb, # childbirth affects iron stores
  IS ~ MC, # miscarriage affects iron stores
  IS ~ Ab, # abortion affects iron stores
  Cb ~ Pre, 
  Ab ~ Pre, 
  MC ~ Pre, 
  Pre ~ HC, 
  Pre ~ Edu, # education level is associated with (age of first) pregnancy
  Mens ~ IS, # Your iron store can influence your menstruation
  Mens ~ AUB, # heavy menstrual bleeding
  Mens ~ ED, # eating disorders effect on HPO axis
  II ~ ED, 
  Mens ~ hypth, # hypothyroidism effect on HPO axis and cause heavy menstrual bleeding (reduces SHBG (sex hormone binding globulin), and the reduction leads to greater estrogen exposure which can cause HMB)
  A ~ hypth, 
  AUB ~ PALM, # structural causes for HMB
  AUB ~ COEIN, # non-structural causes for HMB
  HC ~ Age, # age affect your choice of contraception, should there HC X age interaction (age >35 years relative contraindication for HC)
  HC ~ Edu, # education level affects the choice of HC
  HC ~ Res, # some regions may offer free HC for certain age groups
  HC ~ RelSt, # relationship status associated with need for HC and type of it 
  HC ~ Contr, # contraindication for HC use
  HC ~ Tera, # teratogens (tretinoin, lithium)
  HC ~ Ca, # previous breast cancer contraindication for HC
  HC ~ AUB, 
  HC ~ Acne,
  HC ~ Smoking,
  VE ~ Smoking, # smoking risk factor for venous thorombosis
  AE ~ Smoking, # smoking risk factor for arterial thorombosis
  AE ~ RR, # hypertension is a risk factor for thrombosis
  VE ~ RR, # hypertension is a risk factor for thrombosis  
  Contr ~ RR, # uncontrolled hypertension (1yr exclusion after dx?)
  Contr ~ VE, #  venous thrombosis (-> exclude DVT, PE)
  Contr ~ AE, # arterial thrombosis (-> exclude stroke, TIA, ACS)
  AE ~ Ca, # cancer increases risk for arterial thrombosis
  VE ~ Ca, # cancer increases risk for venous thrombosis
  VE ~ A, #  IDA increases risk of venous thrombosis
  Contr ~ Migr, # aural migraine
  Contr ~ DI, # drug interactions (antiepileptics)
  Iinfl ~ Age, # the older you are the more inflamed you get, "spline"?
  Iinfl ~ MBO, # metabolic syndrome, DM1, DM2
  Iinfl ~ Smoking, 
  Iinfl ~ HC, # use of COC has been linked to higher CRP, on the other hand IUD users in Finland have lower inflammatory markers
  RR ~ Smoking,
  RR ~ Age,
  MBO ~ RR, 
  MBO ~ Ob, # obesity risk factor for MBO
  AUB ~ Ob, # obesity risk factor for HMB
  HC ~ Ob, # obesity (BMI>30) relative contraindication for COC 
  Ca ~ Iinfl, # low grade inflammation -> cancer
  A ~ Ca, # cancer causes anemia
  A ~ Age, # due to iron requirements of growth younger women tend to be more iron deficient aas they have not yet requperated from growth. Should this be a "spline" ? 
 
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "IID" = 'Increased\niron\ndemand',
    "HC" = 'HC use\nand type',
    "Contr" = 'Contraindication\n for HC use',
    "RR" = 'Hypertension',
    "AE" = 'Arterial\nthrombosis',
    "VE" = 'Venous\nthrombosis',
    "Migr" = 'Aural\nmigraine',
    "DI" = 'Drug\ninteractions',
    "Tera" = 'Use of\nteratogens',
    "MBO" = 'MBO',
    "Ca" = 'Cancer',
    "Ob" = 'Obesity',
    "PALM" = 'PALM',
    "COEIN" = 'COEIN',
    "Ab" = 'Abortion',
    "MC" = 'Miscarriage',
    "ED" = 'Eating\ndisorder',
    "Acne" = 'Acne',
    "IBD" = 'IBD',
    "hypth" = 'Hypo-\nthyroidism',
    "GBP" = 'Gastric\nbypass',
    "Smoking" = 'Smoking',
    "Exe" = 'Exercise',
    "Lac" = 'Lactation',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "Inc" = 'Income',
    "Edu" = 'Education\nlevel',
    "Res" = 'Place of\nresidence',
    "RelSt" = 'Relationship\nstatus',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
    "CD" = 'Celiac\ndisease',
    "HP" = 'H. Pylori',
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet',
   "Age" = 'Age',
   "AUB" = 'AUB'
   
  ),
  exposure = "HC",
  outcome = "A"
)

# tried to change node colours herem but this does not work? I wanted factors directly related to IDA to be a separate colour 
# pastricha_dag <- pastricha_dag %>% 
#    set_node_attrs(node = c("Age"), color = "pink")




pastricha_dag.diag <- from_ggdag_2_diagrammer(pastricha_dag_mens)
render_graph(
  pastricha_dag.diag, 
#  layout="tree"
)
```

Now that we have visualized the pathways between hormonal contraception and iron deficiency anemia, we can start building the DAG. 

- is there a way to add color to the mindmap to make it easier for the reader to follow?

# Hormonal contraception and iron deficiency anemia DAG

https://www.r-bloggers.com/2019/08/causal-inference-with-dags-in-r/: Directed cyclical graphs (DAGs) are a powerful tool to understand and deal with causal inference. The book “Causal inference in statistics: a primer” is a useful reference to start, authored from Pearl, Glymour, and Jewell. Directed cyclical graphs (DAGs) are a powerful tool to understand and deal with causal inference. Causal inference in statistics: a primer” is a good resource from. A DAG is a directed acyclic graph, a visual encoding of a joint distribution of a set of variables. In a DAG all the variables are depicted as vertices and connected by arrows or directed paths, sequences of arrows in which every arrow points to some direction. DAGs are acyclic because no directed path can form a closed loop.

https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8821727/ (Tutorial on Directed Acyclic Graphs, Digitale et al.): To create a DAG one must specify: 
1) the causal question of interest, thus necessitating inclusion of exposure/treatment and outcome of interest; 
- causal question: does use of hormonal contraception protect against iron deficiency anemia on a population level?
- exposure: hormonal contraception based on Anatomical Therapeutic Chemical (ATC) codes: G02B “contraceptives for topical use”, G03A “hormonal contraceptives for systemic use”, and G03HB “antiandrogens and oestrogens”. We exclude women who received a prescription with the ATC code “G03AD” (i.e., emergency contraception), as emergency contraception which is widely available without prescription in Finland. Grouping will be done in two ways: by HC substance group (none/COC containing ethinylestradiol/COC containing estradiol/progestin-only) and by ATC code.
- outcome: diagnosis of iron deficiency anemia based on ICD- or ICPC codes.
2) variables that might influence both exposure and outcome (or a mediator of interest) 
3) discrepancies between the ideal measures of the variables and measurements actually available to researchers; 
4) selection factors that influence which patients are represented in the study population; 
5) potential causal relationships among these variables (depicted as arrows connecting variables). 
6) Even if a variable was not measured in the available data (or cannot be measured in most practical settings), it should nonetheless be represented in the DAG. Because the list of potential unmeasured variables can be long, a common convention visually simplifies by representing all unmeasured variables with the same causal structure (i.e., the same arrows in and out) as a single node.

Inflammation
- Possible mechanism though the risk of thromosis: the thrombosis risk of HC related to estrogens effect on the liver, which in turn leads to inflammation and procoagulation (also an effect on the lipid profile, but this effect has been considered minor compared to the other two). The clinical relevance of this higher inflammation is unclear, but as inflammation is linked to iron deficiency anemia we need to consider the it when investigating the causal link of HC and IDA. 
- Hormonal contraception has been associated with inflammation in previous studies: 
1) https://doi.org/10.1210/clinem/dgaa186 (Kangasniemi et al. 2000 Estradiol Valerate in COC Has More Favorable Inflammatory Profile Than Synthetic Ethinyl Estradiol: A Randomized Trial). EV = estradiol valerate, DNG = dienigest, EE = ethinyl estradiol. EV+DNG and DNG only had a neutral effect on inflammation and lipids, while EE+DNG increased both hs-CRP and PTX-3 levels as well as triglycerides and HDL. Professor Terhi Piltonen commented that other factors such as smoking and obesity are likely to have a larger effect than use of HC.  
2) Toffol et al. (https://doi.org/10.1016/j.ajog.2022.06.009) found that LNG-IUD users to have lower inflammatory markers compared to the controls

Unobserved variables:
- iron intake
- chronic disease, adjust for having any special reimbursment Kela code like in Partonen et al. 2023, Sleep medicine?


```{r}

HC_DAG <- ggdag::dagify(
#  II ~ VD, # Low haem iron content (eg, from a vegetarian or vegan diet)
#  II ~ ConInh, # Concomitant consumption of inhibitors of iron absorption (eg, calcium or tea)
#  II ~ InAcid, # Inadequate acidification
#  II ~ InMyc, # Intestinal mycosal dysfunction
  II ~ Edu, # education level is associated with diet, such as vegan diet low in heam iron
  Inc ~ Edu, # education level is associated with income
  Res ~ Inc, # place of residence is associated with income level
  HC ~ Inc, # income affects ability to purchase HC
  IS ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  IS ~ IID, # increased iron demand can cause body iron stores to be depleted, if iron intake is inadequate
#  IID ~ Exe, # exercise causes iron demand
#  IID ~ Lac, # lactation increases iron demand
  IID ~ Pre, # pregnancy increases iron demand
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
  A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  IS ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  IS ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  InLoss ~ IBD, # IBD causes GI blood loss
  Iinfl ~ IBD, # IBD causes inflammation
  Iinfl ~ Ob,
#  InMyc ~ IBD, # IBD causes intestinal dysfunction (through inflammation?)
#  InMyc ~ GBP, # gastric bypass, particularly Roux-en-Y, causes food to bypass duodenum.  
#  InMyc ~ CD, # celiac disease
#  InMyc ~ HP, # H. Pylori
  IS ~ BD, # Blood donation can cause iron deficiency
#  BD ~ IS, # If you are low own iron you can't get to donate 
  IS ~ Cb, # childbirth affects iron stores
  IS ~ MC, # miscarriage affects iron stores
  IS ~ Ab, # abortion affects iron stores
  Cb ~ Pre, 
  Ab ~ Pre, 
  MC ~ Pre, 
  Pre ~ HC, 
  Pre ~ Edu, # education level is associated with (age of first) pregnancy
#  Mens ~ IS, # Your iron store can influence your menstruation
  Mens ~ AUB, # heavy menstrual bleeding
  Mens ~ ED, # eating disorders effect on HPO axis
  II ~ ED, 
  Mens ~ hypth, # hypothyroidism effect on HPO axis and cause heavy menstrual bleeding (reduces SHBG (sex hormone binding globulin), and the reduction leads to greater estrogen exposure which can cause HMB)
  A ~ hypth, 
#  AUB ~ PALM, # structural causes for HMB
#  AUB ~ COEIN, # non-structural causes for HMB
  HC ~ Age, # age affect your choice of contraception, should there HC X age interaction (age >35 years relative contraindication for HC)
  HC ~ Edu, # education level affects the choice of HC
  HC ~ Res, # some regions may offer free HC for certain age groups
#  HC ~ RelSt, # relationship status associated with need for HC and type of it 
  HC ~ Contr, # contraindication for HC use
#  HC ~ Tera, # teratogens (tretinoin, lithium)
  HC ~ Ca, # previous breast cancer contraindication for HC
  HC ~ AUB, # PALM-COEIN
#  HC ~ Acne,
  HC ~ Smoking,
  AEVE ~ Smoking, # smoking risk factor for  thorombosis
  AEVE ~ RR, # hypertension is a risk factor for thrombosis and embolism
  Contr ~ RR, # uncontrolled hypertension (1yr exclusion after dx?)
  Contr ~ AEVE, # arterial thrombosis (-> exclude stroke, TIA, ACS, DVT, PE)
  AEVE ~ Ca, # cancer increases risk for thrombosis
  AEVE ~ A, #  IDA increases risk of venous thrombosis
#  Contr ~ Migr, # aural migraine
#  Contr ~ DI, # drug interactions (antiepileptics)
  Iinfl ~ Age, # the older you are the more inflamed you get, "spline"?
  Iinfl ~ MBO, # metabolic syndrome, DM1, DM2
  Iinfl ~ Smoking, 
  Iinfl ~ HC, # use of COC has been linked to higher CRP, on the other hand IUD users in Finland have lower inflammatory markers
  RR ~ Smoking,
  RR ~ Age,
  MBO ~ RR, 
  MBO ~ Ob, # obesity risk factor for MBO
  AUB ~ Ob, # obesity risk factor for HMB
  HC ~ Ob, # obesity (BMI>30) relative contraindication for COC 
  Ca ~ Iinfl, # low grade inflammation -> cancer
  A ~ Ca, # cancer causes anemia
  A ~ Age, # due to iron requirements of growth younger women tend to be more iron deficient aas they have not yet requperated from growth. Should this be a "spline" ? 
 
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "IID" = 'Increased\niron\ndemand',
    "HC" = 'HC use\nand type',
    "Contr" = 'Contraindication\n for HC use',
    "RR" = 'Hypertension',
    "AE" = 'Arterial\nthrombosis',
    "VE" = 'Venous\nthrombosis',
    "AEVE" = 'Thrombosis/\nembolism',
    "Migr" = 'Aural\nmigraine',
    "DI" = 'Drug\ninteractions',
    "Tera" = 'Use of\nteratogens',
    "MBO" = 'MBO',
    "Ca" = 'Cancer',
    "Ob" = 'Obesity',
    "PALM" = 'PALM',
    "COEIN" = 'COEIN',
    "Ab" = 'Abortion',
    "MC" = 'Miscarriage',
    "ED" = 'Eating\ndisorder',
    "Acne" = 'Acne',
    "IBD" = 'IBD',
    "hypth" = 'Hypo-\nthyroidism',
    "GBP" = 'Gastric\nbypass',
    "Smoking" = 'Smoking',
    "Exe" = 'Exercise',
    "Lac" = 'Lactation',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "Inc" = 'Income',
    "Edu" = 'Education\nlevel',
    "Res" = 'Place of\nresidence',
    "RelSt" = 'Relationship\nstatus',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
    "CD" = 'Celiac\ndisease',
    "HP" = 'H. Pylori',
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet',
   "Age" = 'Age',
   "AUB" = 'AUB'
   
  ),
  exposure = "HC",
  outcome = "A"
)

# tried to change node colours herem but this does not work? I wanted factors directly related to IDA to be a separate colour 
# pastricha_dag <- pastricha_dag %>% 
#    set_node_attrs(node = c("Age"), color = "pink")




hc_dag.diag <- from_ggdag_2_diagrammer(HC_DAG)
render_graph(
  hc_dag.diag, 
#  layout="tree"
)
```




```{r}
latents(HC_DAG) <- c("II","IS", "IID", "Mens", "Pre", "Iinfl", "InLoss")
exposures(HC_DAG) <- c("HC")
outcomes(HC_DAG) <- c("A")

```

Latent variables are not directly measured or observed in the data set (hidden or unobservable). They are used to represent underlying constructs or concepts that cannot be directly quantified, but might influence influence observed variables. Unobserved variables are those for which we lack measurements in the data set- They can be either latent or directly observable, we just lack the ability to measure them. In other words, latent variables represent underlying constructs we can't quantify, while unobserved variables can't be captured due to practical limitations. 

```{r}
ggdag_adjustment_set(HC_DAG)
#how to define the latent variables to get the corract adjustement set
```


```{r}
ggdag_instrumental(pastricha_dag_mens)
```



































# Pastricha DAG with added complexity and exclusions

Child birth and pregnancy create backdoor paths. Exclude all data prior to first pregnancy.
Use of hormonal contraception to treat excessive menstrual flow. Exclude persons with excessive menstrual flow.
Similarly cancer could cause all kinds of loops so all persons with cancer diagnosis are best excluded.

```{r}
pastricha_dag_mens_no <- ggdag::dagify(
  II ~ VD, # Low haem iron content (eg, from a vegetarian or vegan diet)
  II ~ ConInh, # Concomitant consumption of inhibitors of iron absorption (eg, calcium or tea)
  II ~ InAcid, # Inadequate acidification
  II ~ InMyc, # Intestinal mycosal dysfunction
  IS ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
  A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  IS ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  IS ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  IS ~ BD, # Blood donation can cause iron deficiency
  BD ~ IS, # If you are low own iron you can't get to donate 
  Mens ~ IS, # Your iron store can influence your menstruation
  HC ~ Iinfl, # obesity and mentabolic disease can influence your choise of HC
  HC ~ Age, # age affect your choice of contraception, should there HC X age interaction
  Iinfl ~ Age, # the older you are the more inflamed you get, "spline"?
  A ~ Age, # due to iron requirements of growth younger women tend to be more iron deficient aas they have not yet requperated from growth. Should this be a "spline" ? 
 
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "HC" = 'Use/Choise\nof HC',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
   "Erosion" = "Erosion",
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet',
   "Age" = 'Age'
   
  ),
  exposure = "HC",
  outcome = "A"
)

pastricha_dag.diag <- from_ggdag_2_diagrammer(pastricha_dag_mens_no)
render_graph(
  pastricha_dag.diag, 
#  layout="tree"
)
```


```{r}
latents(pastricha_dag_mens_no) <- c("II","IS")
exposures(pastricha_dag_mens_no) <- c("HC")
outcomes(pastricha_dag_mens_no) <- c("A")

```


```{r}
ggdag_adjustment_set(pastricha_dag_mens_no)
```


```{r}
ggdag_instrumental(pastricha_dag_mens_no)
```

# FINAL DAG: Pastricha DAG with added complexity and exclusions + FinnReg & complexity

- Associations for iron deficiency anemia derived from FinnReg added. Some conditions associated with iron deficiency are uncommon in this age group, and have therefore not been included.
- Factors influencing contraception choice and use globally: a synthesis of systematic reviews by D’Souza et al. 2022 (https://doi.org/10.1080/13625187.2022.2096215)
"We found 24 systematic reviews of mostly moderate or high quality. Factors affecting contraception use are remarkably similar among women in very different cultures and settings globally. Use of contraception is influenced by the perceived likelihood and appeal of pregnancy, and relationship status. It is influenced by women’s knowledge, beliefs, and perceptions of side effects and health risks. Male partners have a strong influence, as do peers’ views and experiences, and families’ expectations. Lack of education and poverty is linked with low contraception use, and social and cultural norms influence contraception and expectations of family size and timing. Contraception use also depends upon their availability, the accessibility, confidentiality and costs of health services, and attitudes, behaviour and skills of health practitioners."

```{r}
pastricha_dag_mens_no_fr <- ggdag::dagify(
  #IS ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
  #A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  A ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  A ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  InLoss ~ IBD, # IBD causes GI blood loss
  Iinfl ~ IBD, # IBD causes inflammation
  Iinfl ~ asthma, 
  A ~ BD, # Blood donation can cause iron deficiency
  A ~ Cb, # childbirth affects iron stores
  A ~ MC, # miscarriage affects iron stores
  A ~ Ab, # abortion affects iron stores
  A ~ ED, # eating disorders addect iron stores
  Cb ~ Pre, 
  Ab ~ Pre, 
  MC ~ Pre, 
  Pre ~ HC, 
  #Mens ~ IS, # Your iron store can influence your menstruation
  Mens ~ HMB, # heavy menstrual bleeding
  Mens ~ ED, # eating disorders effect on HPO axis
  Mens ~ hypth, # hypothyroidism effect on HPO axis
  HMB ~ PALM, # structural causes for HMB
  HMB ~ COEIN, # non-structural causes for HMB
  HC ~ Age, # age affect your choice of contraception, should there HC X age interaction
  HC ~ Contr, # contraindication for HC use
  HC ~ Tera, # teratogens (tretinoin, lithium)
  HC ~ HMB, 
  HC ~ Acne,
  HC ~ Smoking,
  Contr ~ RR, # uncontrolled hypertension (1yr exclusion after dx?)
  Contr ~ VE, #  venous thrombosis (-> exclude DVT, PE)
  Contr ~ AE, # arterial thrombosis (-> exclude stroke, TIA, ACS)
  Contr ~ Migr, # aural migraine
  Contr ~ DI, # drug interactions (antiepileptics)
  Iinfl ~ MBO, # metabolisc syndrome
  Iinfl ~ Smoking, 
  RR ~ Smoking,
  VE ~ Smoking,
  AE ~ Smoking,
  MBO ~ Ob, # obesity risk factor for MBO
  HMB ~ Ob, # obesity risk factor for HMB
  Iinfl ~ Ca, # low grade inflammation -> cancer
  A ~ Ca, # cancer causes anemia
  A ~ Age, # due to iron requirements of growth younger women tend to be more iron deficient aas they have not yet requperated from growth. Should this be a "spline" ? 
 
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "HC" = 'Use/Choise\nof HC',
    "Contr" = 'Contraindication\n for HC use',
    "RR" = 'Hypertension',
    "AE" = 'Arterial\nthrombosis',
    "VE" = 'Venous\nthrombosis',
    "Migr" = 'Aural\nmigraine',
    "DI" = 'Drug\ninteractions',
    "Tera" = 'Use of\nteratogens',
    "MBO" = 'MBO',
    "Ca" = 'Cancer',
    "Ob" = 'Obesity',
    "PALM" = 'PALM',
    "COEIN" = 'COEIN',
    "Ab" = 'Abortion',
    "MC" = 'Miscarriage',
    "ED" = 'Eating\ndisorder',
    "Acne" = 'Acne',
    "IBD" = 'IBD',
    "hypth" = 'Hypo-\nthyroidism',
    "GBP" = 'Gastric\nbypass',
    "Smoking" = 'Smoking',
    "asthma" = 'Asthma',
    # "" = '',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet',
   "Age" = 'Age',
   "HMB" = 'HMB\nN92'
   
  ),
  exposure = "HC",
  outcome = "A"
)

pastricha_dag.diag <- from_ggdag_2_diagrammer(pastricha_dag_mens_no_fr)
render_graph(
  pastricha_dag.diag, 
#  layout="tree"
)
```

Inflammation increases risk of anemia but is not an observable variable in our study. However, as many factors involved in the DAG cause inflammation it cannot be a latent variable and needs to be adjusted for. To  

```{r}
latents(pastricha_dag_mens_no_fr) <- c("Mens", "Smoking", "BD", "Pre", "DI") 
exposures(pastricha_dag_mens_no_fr) <- c("HC")
outcomes(pastricha_dag_mens_no_fr) <- c("A")

```


```{r}
ggdag_adjustment_set(pastricha_dag_mens_no_fr)
```
Inflammation increases risk of anemia but is not an observable variable in our study. Instead, we will adjust for factors that cause inflammation.  


```{r}
ggdag_instrumental(pastricha_dag_mens_no_fr)
```

# Dagitty

```{r}
library(dagitty)

g <- dagitty('dag {
bb="-5.138,-7.891,4.859,6.577"
"Contraindications of HC" [pos="3.753,-2.147"]
"Education level" [pos="-1.893,-2.436"]
"HC use and type" [exposure,pos="0.468,-2.881"]
"Heavy menstrual bleeding (PALM-COEIN)" [pos="-1.613,-1.085"]
"Iron intake" [latent,pos="-3.967,-1.649"]
"Metabolic syndrome" [pos="-0.494,3.132"]
"Place of residence" [pos="0.099,-6.685"]
"Relationship status" [pos="3.402,-5.250"]
Abortion [pos="-3.973,2.750"]
Age [pos="2.933,-0.209"]
Cancer [pos="3.586,2.317"]
Childbirth [pos="-2.588,4.014"]
Hypothyroidism [pos="-4.305,0.375"]
IBD [pos="0.758,5.372"]
IDA [outcome,pos="-0.344,1.038"]
Income [pos="-1.318,-5.170"]
Inflammation [latent,pos="2.083,2.791"]
Miscarriage [latent,pos="0.191,3.885"]
Obesity [latent,pos="1.496,0.268"]
Pregnancy [pos="-1.984,0.769"]
Smoking [latent,pos="4.026,0.666"]
"Contraindications of HC" -> "HC use and type"
"Education level" -> "HC use and type"
"Education level" -> "Iron intake"
"Education level" -> Income
"Education level" -> Pregnancy
"HC use and type" -> "Heavy menstrual bleeding (PALM-COEIN)"
"HC use and type" -> IDA
"HC use and type" -> Pregnancy
"Heavy menstrual bleeding (PALM-COEIN)" -> IDA
"Iron intake" -> IDA
"Metabolic syndrome" -> Inflammation
"Place of residence" -> "HC use and type"
"Relationship status" -> "HC use and type"
Abortion -> IDA
Age -> "Contraindications of HC"
Age -> IDA
Age <-> Inflammation
Cancer -> IDA
Childbirth -> IDA
Hypothyroidism -> "Heavy menstrual bleeding (PALM-COEIN)"
Hypothyroidism -> IDA
IBD -> IDA
IBD -> Inflammation
Income -> "HC use and type"
Income -> "Place of residence"
Inflammation -> Cancer
Inflammation -> IDA
Miscarriage -> IDA
Obesity -> "Contraindications of HC"
Obesity -> "Heavy menstrual bleeding (PALM-COEIN)"
Obesity -> "Metabolic syndrome"
Obesity -> Cancer
Obesity -> Inflammation
Pregnancy -> Abortion
Pregnancy -> Childbirth
Pregnancy -> IDA
Pregnancy -> Miscarriage
Smoking -> "Contraindications of HC"
Smoking -> IDA
Smoking -> Inflammation
}')
plot(g)
```

```{r}
# all paths between HC and IDA
paths(g, "HC use and type", "IDA")
```
```{r}
impliedConditionalIndependencies(g)
```
## Minimal adjustment set

```{r}
# Minimal adjustment set
print("The minimal adjustment set")
adjustmentSets(g,"HC use and type","IDA")

```

At a minimum, HC contraindications and education level needs to be adjusted for to close biasing paths



