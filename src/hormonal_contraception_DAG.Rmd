---
title: "DAG for anemia in FinOCCo"
author: "Mikko Arvas and Sofie Ekroos"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

VERSION 1

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DiagrammeR)
library(ggdag)
library(causaleffect)
library(igraph)
library(tidyverse)
library(dagitty)
library(ggdag)
library(tidygraph)
```


# Functions

```{r}
from_ggdag_2_diagrammer <- function(ggdag.object) {
  tmp <- tidy_dagitty(ggdag.object)$data
 #tmp <- tidy_dagitty(anemia_dag)$data
  edges <- tmp %>% 
    select(name, to) %>% 
    rename("from"="name") %>% 
    na.omit()
  
   nodes <- tmp %>% 
   select(name,label) %>%
   #  select(name) %>% 
   rename("id"="name") %>%
   distinct() %>%
   na.omit()
  g <- create_graph(
    directed = TRUE,
    attr_theme = "tb"
  )
  g<- add_nodes_from_table(g,
                           table = nodes,
                           label_col = label)
  g <- add_edges_from_table(graph =g,
                            table=edges,
                            from_col = from,
                            to_col = to,
                            from_to_map=id_external)
  invisible(g)
}

```


```{r}
from_ggdag_2_igraph <- function(dagify.object) {
  tmp <- tidy_dagitty(dagify.object)$data
  tmp <- tmp %>% select(name, to) %>% 
  as.matrix() %>% # igraph wants a matrix
  na.omit() #there was A -> NA , maybe to spesify outcome
  tmp <- graph_from_edgelist(tmp, directed = TRUE)
  invisible(tmp)
}

```


# Pastricha DAG with hormonal contraception

Based on "Iron deficiency" 
Sant-Rayn Pasricha, Jason Tye-Din, Martina U Muckenthaler, Dorine W Swinkels 2021 Lancet
http://dx.doi.org/10.1016/S0140-6736(20)32594-0

```{r}

pastricha_dag <- ggdag::dagify(
  II ~ VD, # Low haem iron content (eg, from a vegetarian or vegan diet)
  II ~ ConInh, # Concomitant consumption of inhibitors of iron absorption (eg, calcium or tea)
  II ~ InAcid, # Inadequate acidification
  II ~ InMyc, # Intestinal mycosal dysfunction
  IS ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
  A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  IS ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  IS ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  IS ~ BD,
  IS ~ Cb,
  Cb ~ Pre,
  
  
  
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "HC" = 'Use/Choise\nof HC',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
   "Erosion" = "Erosion",
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet'
   
  ),
  exposure = "HC",
  outcome = "A"
)

pastricha_dag.diag <- from_ggdag_2_diagrammer(pastricha_dag)
render_graph(
  pastricha_dag.diag, 
#  layout="tree"
)
```

```{r}
latents(pastricha_dag) <- c("II","IS")
exposures(pastricha_dag) <- c("HC")
outcomes(pastricha_dag) <- c("A")

```


```{r}
ggdag_adjustment_set(pastricha_dag)
#how to define the latent variables to get the corract adjustement set
```

‘Backdoor Paths Unconditionally Closed’ means that, assuming the DAG we have drawn is correct, we may obtain an unbiased estimate of X on Y without including additional variables.

```{r}
ggdag_instrumental(pastricha_dag)
```

# Mindmap of factors related to iron deficiency anemia

Here we draw a mindmap with the intent of visualizing factors related to iron deficiency anemia (IDA) in Finnish premenopausal women. Although the the mindmap is drawn using the same code for drawing the final DAG, it does not fulfill the criteria for DAGs (for example, this one includes loops) and should not be used for analysis. 

Sources:

- IDA endpoint in FinRegistry (search term D3_ANAEMIA_IRONDEF), list of relationships between endpoints. Pathologies unlikely in premenopausal women or very uncommon not included in this mindmap. "In FinRegistry we include all the individuals that lived in Finland and were alive on the 1st of January 2010 as well as their parents, spouses, children, and siblings. The research data will be updated until 2025. You can explore disease endpoints at risteys.finregistry.fi."
- VTE associated with IDA not only through FinRegistry, but there is also evidence elsewhere:
* 1) Association between venous thromboembolism and iron-deficiency anemia : a population-based study, Hung et al. 2015, Blood Coagulation & Fibrinolysis, doi: 10.1097/MBC.0000000000000249. "The most reasonable explanation for the relationship between IDA and VTE is possibly secondary thrombocytosis that results from an iron deficiency . It is known that thrombocytosis frequently accompanies less-severe anemia of iron deficiency and may be related to platelet stimulation in a manner analogous to the increase in erythropoietin seen in many anemic states . Some researchers stated that an iron deficiency status is considered a risk factor for thrombocytosis and should, wherever possible, be avoided . Although the influence of secondary thrombocytosis on the development of a VTE appears to be quite rational, researchers have argued that this view might be an oversimplification, as some other studies showed decreased platelet aggregation in patients with an iron deficiency, and isovolemic hemodilution leads to a shortening of the reaction and coagulation times in a hematocrit-dependent manner. Another possible explanation is that the increase in plasminogen activator inhibitor-1 in anemia may cause decreased fibrinolytic activity in IDA . This mechanism is supported by evidence that the plasminogen activator inhibitor-1 was markedly increased in a case reported by Bukharovich et al. . In a recent study by Livesey et al. , those authors found that in patients with hereditary hemorrhagic telangiectasia, low serum iron levels were associated with elevated plasma levels of coagulation factor VIII and a venous thromboembolic risk . Although the mechanism for iron loss in those patients was attributed to inadequate replacement of hemorrhagic iron losses, with a similar iron deficiency status, patients with IDA might also be associated with an increased risk for a VTE. Finally, it is also possible that the increased sheer force caused by an anemia-induced hyperdynamic state can result in endothelial injuries and subsequent thrombus formation."
* 2) Association between Iron Deficiency Anemia and Thrombosis, a Population Based Study Laber et al 2023 Blood, https://doi.org/10.1182/blood-2023-190934 (for second one only abstract available)
- Factors influencing contraception choice and use globally: a synthesis of systematic reviews by D’Souza et al. 2022 (https://doi.org/10.1080/13625187.2022.2096215)
"We found 24 systematic reviews of mostly moderate or high quality. Factors affecting contraception use are remarkably similar among women in very different cultures and settings globally. Use of contraception is influenced by the perceived likelihood and appeal of pregnancy, and relationship status. It is influenced by women’s knowledge, beliefs, and perceptions of side effects and health risks. Male partners have a strong influence, as do peers’ views and experiences, and families’ expectations. Lack of education and poverty is linked with low contraception use, and social and cultural norms influence contraception and expectations of family size and timing. Contraception use also depends upon their availability, the accessibility, confidentiality and costs of health services, and attitudes, behaviour and skills of health practitioners."
- Factors associated with iron deficiency and how they can be used in blood donor selection processes (Sofie Ekroos, Mikko Arvas, Johanna Castrén, https://doi.org/10.1101/2022.02.01.22270122)
- https://www.uptodate.com/contents/causes-and-diagnosis-of-iron-deficiency-and-iron-deficiency-anemia-in-adults 

```{r}

pastricha_dag_mens <- ggdag::dagify(
  II ~ VD, # Low haem iron content (eg, from a vegetarian or vegan diet)
  II ~ ConInh, # Concomitant consumption of inhibitors of iron absorption (eg, calcium or tea)
  II ~ InAcid, # Inadequate acidification
  II ~ InMyc, # Intestinal mycosal dysfunction
  VD ~ Edu, # education level is associated with diet, such as vegan diet low in heam iron
  Inc ~ Edu, # education level is associated with income
  Res ~ Inc, # place of residence is associated with income level
  HC ~ Inc, # income affects ability to purchase HC
  IS ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  IS ~ IID, # increased iron demand can cause body iron stores to be depleted, if iron intake is inadequate
  IID ~ Exe, # exercise causes iron demand
  IID ~ Lac, # lactation increases iron demand
  IID ~ Pre, # pregnancy increases iron demand
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
  A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  A ~ HC, # our exposure to outcome question, HC influences IDA not only through decreased menstrual blood loss, but also though effect on hepcidin (estrogen pos associated, progesterone neg association), parhaps also other mechanisms?
  IS ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  IS ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  InLoss ~ IBD, # IBD causes GI blood loss
  Iinfl ~ IBD, # IBD causes inflammation
  Iinfl ~ Ob,
  InMyc ~ IBD, # IBD causes intestinal dysfunction (through inflammation?)
  InMyc ~ GBP, # gastric bypass, particularly Roux-en-Y, causes food to bypass duodenum.  
  InMyc ~ CD, # celiac disease
  InMyc ~ HP, # H. Pylori
  IS ~ BD, # Blood donation can cause iron deficiency
  BD ~ IS, # If you are low own iron you can't get to donate 
  IS ~ Cb, # childbirth affects iron stores
  IS ~ MC, # miscarriage affects iron stores
  IS ~ Ab, # abortion affects iron stores
  Cb ~ Pre, 
  Ab ~ Pre, 
  MC ~ Pre, 
  Pre ~ HC, 
  Pre ~ Edu, # education level is associated with (age of first) pregnancy
  Mens ~ IS, # Your iron store can influence your menstruation
  Mens ~ AUB, # heavy menstrual bleeding
  Mens ~ ED, # eating disorders effect on HPO axis
  II ~ ED, 
  Mens ~ hypth, # hypothyroidism effect on HPO axis and cause heavy menstrual bleeding (reduces SHBG (sex hormone binding globulin), and the reduction leads to greater estrogen exposure which can cause HMB)
  A ~ hypth, 
  AUB ~ PALM, # structural causes for HMB
  AUB ~ COEIN, # non-structural causes for HMB
  HC ~ Age, # age affect your choice of contraception, should there HC X age interaction (age >35 years relative contraindication for HC)
  HC ~ Edu, # education level affects the choice of HC
  HC ~ Res, # some regions may offer free HC for certain age groups
  HC ~ RelSt, # relationship status associated with need for HC and type of it 
  HC ~ Contr, # contraindication for HC use
  HC ~ Tera, # teratogens (tretinoin, lithium)
  HC ~ Ca, # previous breast cancer contraindication for HC
  HC ~ AUB, 
  HC ~ Acne,
  HC ~ Smoking,
  VE ~ Smoking, # smoking risk factor for venous thorombosis
  AE ~ Smoking, # smoking risk factor for arterial thorombosis
  AE ~ RR, # hypertension is a risk factor for thrombosis
  VE ~ RR, # hypertension is a risk factor for thrombosis  
  Contr ~ RR, # uncontrolled hypertension (1yr exclusion after dx?)
  Contr ~ VE, #  venous thrombosis (-> exclude DVT, PE)
  Contr ~ AE, # arterial thrombosis (-> exclude stroke, TIA, ACS)
  AE ~ Ca, # cancer increases risk for arterial thrombosis
  VE ~ Ca, # cancer increases risk for venous thrombosis
  VE ~ A, #  IDA increases risk of venous thrombosis
  Contr ~ Migr, # aural migraine
  Contr ~ DI, # drug interactions (antiepileptics)
  Iinfl ~ Age, # the older you are the more inflamed you get, "spline"?
  Iinfl ~ MBO, # metabolic syndrome, DM1, DM2
  Iinfl ~ Smoking, 
  Iinfl ~ HC, # use of COC has been linked to higher CRP, on the other hand IUD users in Finland have lower inflammatory markers
  RR ~ Smoking,
  RR ~ Age,
  MBO ~ RR, 
  MBO ~ Ob, # obesity risk factor for MBO
  AUB ~ Ob, # obesity risk factor for HMB
  HC ~ Ob, # obesity (BMI>30) relative contraindication for COC 
  Ca ~ Iinfl, # low grade inflammation -> cancer
  A ~ Ca, # cancer causes anemia
  A ~ Age, # due to iron requirements of growth younger women tend to be more iron deficient aas they have not yet requperated from growth. Should this be a "spline" ? 
 
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "IID" = 'Increased\niron\ndemand',
    "HC" = 'HC use\nand type',
    "Contr" = 'Contraindication\n for HC use',
    "RR" = 'Hypertension',
    "AE" = 'Arterial\nthrombosis',
    "VE" = 'Venous\nthrombosis',
    "Migr" = 'Aural\nmigraine',
    "DI" = 'Drug\ninteractions',
    "Tera" = 'Use of\nteratogens',
    "MBO" = 'MBO',
    "Ca" = 'Cancer',
    "Ob" = 'Obesity',
    "PALM" = 'PALM',
    "COEIN" = 'COEIN',
    "Ab" = 'Abortion',
    "MC" = 'Miscarriage',
    "ED" = 'Eating\ndisorder',
    "Acne" = 'Acne',
    "IBD" = 'IBD',
    "hypth" = 'Hypo-\nthyroidism',
    "GBP" = 'Gastric\nbypass',
    "Smoking" = 'Smoking',
    "Exe" = 'Exercise',
    "Lac" = 'Lactation',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "Inc" = 'Income',
    "Edu" = 'Education\nlevel',
    "Res" = 'Place of\nresidence',
    "RelSt" = 'Relationship\nstatus',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
    "CD" = 'Celiac\ndisease',
    "HP" = 'H. Pylori',
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet',
   "Age" = 'Age',
   "AUB" = 'AUB'
   
  ),
  exposure = "HC",
  outcome = "A"
)

pastricha_dag.diag <- from_ggdag_2_diagrammer(pastricha_dag_mens)
render_graph(
  pastricha_dag.diag, 
#  layout="tree"
)
```

## Colored mindmap

For the manuscript, we will want to color specific pathways for different subgroup analysis to make it easier for the reader to follow. 

Possible attributes to set:

```{r}
get_global_graph_attr_info(pastricha_dag.diag)
```


```{r}
get_node_df(pastricha_dag.diag)
```


id|label|id_external
1		Iron\ndeficiency\nanemia	A	
2		Arterial\nthrombosis	AE	
3		AUB	AUB	
4		Abortion	Ab	
5		Acne	Acne	
6		Age	Age	
7		Blood\ndonation	BD	
8		Celiac\ndisease	CD	
9		COEIN	COEIN	
10		Cancer	Ca	
11		Child\nbirth	Cb	
12		Consumption\nof inhibitors	ConInh	
13		Contraindication\n for HC use	Contr	
14		Drug\ninteractions	DI	
15		Eating\ndisorder	ED	
16		Education\nlevel	Edu	
17		Exercise	Exe	
18		Gastric\nbypass	GBP	
19		HC use\nand type	HC	
20		H. Pylori	HP	
21		IBD	IBD	
22		Iron\nintake	II	
23		Increased\niron\ndemand	IID	
24		Iron\nstores	IS	
25		Inflammation	Iinfl	
26		Inadequate\nacidification	InAcid	
27		Gastrointestinal\nblood loss	InLoss	
28		Intestinal\ndysfunction	InMyc	
29		Income	Inc	
30		Lactation	Lac	
31		MBO	MBO	
32		Miscarriage	MC	
33		Menstruation	Mens	
34		Aural\nmigraine	Migr	
35		Obesity	Ob	
36		PALM	PALM	
37		Pregnancy	Pre	
38		Hypertension	RR	
39		Relationship\nstatus	RelSt	
40		Place of\nresidence	Res	
41		Smoking	Smoking	
42		Use of\nteratogens	Tera	
43		Low\niron\ndiet	VD	
44		Venous\nthrombosis	VE	
45		Hypo-\nthyroidism	hypth	
45 rows

You can add arbitrary columns to node_df and set plotting attributes based on them. 

For example, let's color the menstruation pathway as well as the exposure and outcome.

```{r}
# start by adding border colors
g1 <-
  pastricha_dag.diag %>%
  set_node_attrs(
    node_attr = color,
    values = "#FFBF65") %>% # the coloring if no node specified 
  set_node_attrs(
    node_attr = color,
    values = "#8DD7BF",
    nodes = c(1)) %>% # specify nodes separately, you can add nodes within the bracket, separate with ,
  set_node_attrs(
    node_attr = color,
    values = "#00A5E3",
    nodes = c(19)) %>%
  set_node_attrs(
    node_attr = color,
    values = "#FF5768",
    nodes = c(1,3,9,19,24,33,36)) 

render_graph(
  g1, 
)

```

id|label|id_external
1		Iron\ndeficiency\nanemia	A	
2		Arterial\nthrombosis	AE	
3		AUB	AUB	
4		Abortion	Ab	
5		Acne	Acne	
6		Age	Age	
7		Blood\ndonation	BD	
8		Celiac\ndisease	CD	
9		COEIN	COEIN	
10		Cancer	Ca	
11		Child\nbirth	Cb	
12		Consumption\nof inhibitors	ConInh	
13		Contraindication\n for HC use	Contr	
14		Drug\ninteractions	DI	
15		Eating\ndisorder	ED	
16		Education\nlevel	Edu	
17		Exercise	Exe	
18		Gastric\nbypass	GBP	
19		HC use\nand type	HC	
20		H. Pylori	HP	
21		IBD	IBD	
22		Iron\nintake	II	
23		Increased\niron\ndemand	IID	
24		Iron\nstores	IS	
25		Inflammation	Iinfl	
26		Inadequate\nacidification	InAcid	
27		Gastrointestinal\nblood loss	InLoss	
28		Intestinal\ndysfunction	InMyc	
29		Income	Inc	
30		Lactation	Lac	
31		MBO	MBO	
32		Miscarriage	MC	
33		Menstruation	Mens	
34		Aural\nmigraine	Migr	
35		Obesity	Ob	
36		PALM	PALM	
37		Pregnancy	Pre	
38		Hypertension	RR	
39		Relationship\nstatus	RelSt	
40		Place of\nresidence	Res	
41		Smoking	Smoking	
42		Use of\nteratogens	Tera	
43		Low\niron\ndiet	VD	
44		Venous\nthrombosis	VE	
45		Hypo-\nthyroidism	hypth	
45 rows

```{r}
# fill node 
g2 <-
  g1 %>%
  set_node_attrs(
    node_attr = fillcolor,
    values = "#FFBF65") %>% # color if node is not specified
  set_node_attrs(
    node_attr = fillcolor,
    values = "#8DD7BF", # this makes text white
    nodes = c(1)) %>% 
    set_node_attrs(
    node_attr = fontcolor,
    values = "black") %>% # this makes text white
  set_node_attrs(
    node_attr = fillcolor,
    values = "#00A5E3", 
    nodes = c(19)) %>% 
    set_node_attrs(
    node_attr = fontcolor,
    values = "black")  
    


render_graph(
  g2, 
)

```

```{r}
get_edge_df(g2)
```

id|label|id_external
1		Iron\ndeficiency\nanemia	A	
2		Arterial\nthrombosis	AE	
3		AUB	AUB	
4		Abortion	Ab	
5		Acne	Acne	
6		Age	Age	
7		Blood\ndonation	BD	
8		Celiac\ndisease	CD	
9		COEIN	COEIN	
10		Cancer	Ca	
11		Child\nbirth	Cb	
12		Consumption\nof inhibitors	ConInh	
13		Contraindication\n for HC use	Contr	
14		Drug\ninteractions	DI	
15		Eating\ndisorder	ED	
16		Education\nlevel	Edu	
17		Exercise	Exe	
18		Gastric\nbypass	GBP	
19		HC use\nand type	HC	
20		H. Pylori	HP	
21		IBD	IBD	
22		Iron\nintake	II	
23		Increased\niron\ndemand	IID	
24		Iron\nstores	IS	
25		Inflammation	Iinfl	
26		Inadequate\nacidification	InAcid	
27		Gastrointestinal\nblood loss	InLoss	
28		Intestinal\ndysfunction	InMyc	
29		Income	Inc	
30		Lactation	Lac	
31		MBO	MBO	
32		Miscarriage	MC	
33		Menstruation	Mens	
34		Aural\nmigraine	Migr	
35		Obesity	Ob	
36		PALM	PALM	
37		Pregnancy	Pre	
38		Hypertension	RR	
39		Relationship\nstatus	RelSt	
40		Place of\nresidence	Res	
41		Smoking	Smoking	
42		Use of\nteratogens	Tera	
43		Low\niron\ndiet	VD	
44		Venous\nthrombosis	VE	
45		Hypo-\nthyroidism	hypth	
45 rows

```{r}
# color arrows, specify start and end nodes
g3 <-
  g2 %>%
  DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = color,
    values = "#FFBF65" # not specifying nodes makes all arrows the chosen color
  ) %>%
  DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = color,
    values = "#FF5768", 
    from = 19,
    to =1
  ) %>%   
  DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = arrowsize,
    values = 2, 
    from = 19,
    to =1
  ) %>%
  DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = color,
    values = "#FF5768", 
    from = 19,
    to =33
  ) %>%   DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = arrowsize,
    values = 2, 
    from = 19,
    to =33
  ) %>%
  DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = color,
    values = "#FF5768", 
    from = 3,
    to =33
  ) %>%   DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = arrowsize,
    values = 2, 
    from = 3,
    to =33
  ) %>%
  DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = color,
    values = "#FF5768", 
    from = 9,
    to = 3
  ) %>%   DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = arrowsize,
    values = 2, 
    from = 9,
    to =3
  )   %>%
  DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = color,
    values = "#FF5768", 
    from = 36,
    to =3
  ) %>%   DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = arrowsize,
    values = 2, 
    from = 36,
    to =3
  ) %>%
  DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = color,
    values = "#FF5768", 
    from = 33,
    to = 24
  ) %>%   DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = arrowsize,
    values = 2, 
    from = 33,
    to = 24
  )   %>%
  DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = color,
    values = "#FF5768", 
    from = 24,
    to =33
  ) %>%   DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = arrowsize,
    values = 2, 
    from = 24,
    to =33
  ) %>%
  DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = color,
    values = "#FF5768", 
    from = 24,
    to =1
  ) %>%   DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = arrowsize,
    values = 2, 
    from = 24,
    to =1
  ) 
  

render_graph(
  g3, 
)

```


```{r}
# make the borders of the pathway chosen pathway thicker (thickness is put on top of the most recently changed borders)
g4 <-
  g3 %>%
    set_node_attrs(
    node_attr = penwidth,
    values = "4") 
     
  

render_graph(
  g4, 
)




```

Now that we have visualized the pathways between hormonal contraception and iron deficiency anemia, we can start building the DAG. 

# Hormonal contraception and iron deficiency anemia DAG

https://www.r-bloggers.com/2019/08/causal-inference-with-dags-in-r/: Directed cyclical graphs (DAGs) are a powerful tool to understand and deal with causal inference. The book “Causal inference in statistics: a primer” is a useful reference to start, authored from Pearl, Glymour, and Jewell. Directed cyclical graphs (DAGs) are a powerful tool to understand and deal with causal inference. Causal inference in statistics: a primer” is a good resource from. A DAG is a directed acyclic graph, a visual encoding of a joint distribution of a set of variables. In a DAG all the variables are depicted as vertices and connected by arrows or directed paths, sequences of arrows in which every arrow points to some direction. DAGs are acyclic because no directed path can form a closed loop.

https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8821727/ (Tutorial on Directed Acyclic Graphs, Digitale et al.): To create a DAG one must specify: 
1) the causal question of interest, thus necessitating inclusion of exposure/treatment and outcome of interest; 
- causal question: does use of hormonal contraception protect against iron deficiency anemia on a population level?
- exposure: hormonal contraception based on Anatomical Therapeutic Chemical (ATC) codes: G02B “contraceptives for topical use”, G03A “hormonal contraceptives for systemic use”, and G03HB “antiandrogens and oestrogens”. We exclude women who received a prescription with the ATC code “G03AD” (i.e., emergency contraception), as emergency contraception which is widely available without prescription in Finland. Grouping will be done in two ways: by HC substance group (none/COC containing ethinylestradiol/COC containing estradiol/progestin-only) and by ATC code.
- outcome: diagnosis of iron deficiency anemia based on ICD- or ICPC codes.
2) variables that might influence both exposure and outcome (or a mediator of interest) 
3) discrepancies between the ideal measures of the variables and measurements actually available to researchers; 
4) selection factors that influence which patients are represented in the study population; 
5) potential causal relationships among these variables (depicted as arrows connecting variables). 
6) Even if a variable was not measured in the available data (or cannot be measured in most practical settings), it should nonetheless be represented in the DAG. Because the list of potential unmeasured variables can be long, a common convention visually simplifies by representing all unmeasured variables with the same causal structure (i.e., the same arrows in and out) as a single node.

Inflammation
- Possible mechanism though the risk of thromosis: the thrombosis risk of HC related to estrogens effect on the liver, which in turn leads to inflammation and procoagulation (also an effect on the lipid profile, but this effect has been considered minor compared to the other two). The clinical relevance of this higher inflammation is unclear, but as inflammation is linked to iron deficiency anemia we need to consider the it when investigating the causal link of HC and IDA. 
- Hormonal contraception has been associated with inflammation in previous studies: 
1) https://doi.org/10.1210/clinem/dgaa186 (Kangasniemi et al. 2000 Estradiol Valerate in COC Has More Favorable Inflammatory Profile Than Synthetic Ethinyl Estradiol: A Randomized Trial). EV = estradiol valerate, DNG = dienigest, EE = ethinyl estradiol. EV+DNG and DNG only had a neutral effect on inflammation and lipids, while EE+DNG increased both hs-CRP and PTX-3 levels as well as triglycerides and HDL. Professor Terhi Piltonen commented that other factors such as smoking and obesity are likely to have a larger effect than use of HC.  
2) Toffol et al. (https://doi.org/10.1016/j.ajog.2022.06.009) found that LNG-IUD users to have lower inflammatory markers compared to the controls

Unobserved variables:
- iron intake
- chronic disease, adjust for having any special reimbursment Kela code like in Partonen et al. 2023, Sleep medicine?

We need to draw two separate DAGs: one with all pathways visualized, and one for calculating the adjustment sets

## HC and IDA DAG: pathways

```{r}
HC_DAG <- ggdag::dagify(
#  II ~ VD, # Low haem iron content (eg, from a vegetarian or vegan diet)
#  II ~ ConInh, # Concomitant consumption of inhibitors of iron absorption (eg, calcium or tea)
#  II ~ InAcid, # Inadequate acidification
#  II ~ InMyc, # Intestinal mycosal dysfunction
  II ~ Edu, # education level is associated with diet, such as vegan diet low in heam iron
  Inc ~ Edu, # education level is associated with income
  Res ~ Inc, # place of residence is associated with income level
  HC ~ Inc, # income affects ability to purchase HC
  IS ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  IS ~ IID, # increased iron demand can cause body iron stores to be depleted, if iron intake is inadequate
#  IID ~ Exe, # exercise causes iron demand
#  IID ~ Lac, # lactation increases iron demand
  IID ~ Pre, # pregnancy increases iron demand
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
  A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  A ~ HC, # our exposure to outcome question, HC influences IDA not only through decreased menstrual blood loss, but also though effect on hepcidin (estrogen pos associated, progesterone neg association), parhaps also other mechanisms?
  IS ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  IS ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  InLoss ~ IBD, # IBD causes GI blood loss
  Iinfl ~ IBD, # IBD causes inflammation
  Iinfl ~ Ob,
#  InMyc ~ IBD, # IBD causes intestinal dysfunction (through inflammation?)
#  InMyc ~ GBP, # gastric bypass, particularly Roux-en-Y, causes food to bypass duodenum.  
#  InMyc ~ CD, # celiac disease
#  InMyc ~ HP, # H. Pylori
  IS ~ BD, # Blood donation can cause iron deficiency
#  BD ~ IS, # If you are low own iron you can't get to donate 
  IS ~ Cb, # childbirth affects iron stores
  IS ~ MC, # miscarriage affects iron stores
  IS ~ Ab, # abortion affects iron stores
  Cb ~ Pre, 
  Ab ~ Pre, 
  MC ~ Pre, 
  Pre ~ HC, 
  Pre ~ Edu, # education level is associated with (age of first) pregnancy
#  Mens ~ IS, # Your iron store can influence your menstruation
  Mens ~ AUB, # heavy menstrual bleeding
  Mens ~ ED, # eating disorders effect on HPO axis
  II ~ ED, 
  Mens ~ hypth, # hypothyroidism effect on HPO axis and cause heavy menstrual bleeding (reduces SHBG (sex hormone binding globulin), and the reduction leads to greater estrogen exposure which can cause HMB)
  A ~ hypth, 
#  AUB ~ PALM, # structural causes for HMB
#  AUB ~ COEIN, # non-structural causes for HMB
  HC ~ Age, # age affect your choice of contraception, should there HC X age interaction (age >35 years relative contraindication for HC)
  HC ~ Edu, # education level affects the choice of HC
  HC ~ Res, # some regions may offer free HC for certain age groups
#  HC ~ RelSt, # relationship status associated with need for HC and type of it 
  HC ~ Contr, # contraindication for HC use
#  HC ~ Tera, # teratogens (tretinoin, lithium)
  HC ~ Ca, # previous breast cancer contraindication for HC
  HC ~ AUB, # PALM-COEIN
#  HC ~ Acne,
  HC ~ Smoking,
  AEVE ~ Smoking, # smoking risk factor for  thorombosis
  AEVE ~ RR, # hypertension is a risk factor for thrombosis and embolism
  Contr ~ RR, # uncontrolled hypertension (1yr exclusion after dx?)
  Contr ~ AEVE, # arterial thrombosis (-> exclude stroke, TIA, ACS, DVT, PE)
  AEVE ~ Ca, # cancer increases risk for thrombosis
  AEVE ~ A, #  IDA increases risk of venous thrombosis
#  Contr ~ Migr, # aural migraine
#  Contr ~ DI, # drug interactions (antiepileptics)
  Iinfl ~ Age, # the older you are the more inflamed you get, "spline"?
  Iinfl ~ MBO, # metabolic syndrome, DM1, DM2
  Iinfl ~ Smoking, 
  Iinfl ~ HC, # use of COC has been linked to higher CRP, on the other hand IUD users in Finland have lower inflammatory markers
  RR ~ Smoking,
  RR ~ Age,
  MBO ~ RR, 
  MBO ~ Ob, # obesity risk factor for MBO
  AUB ~ Ob, # obesity risk factor for HMB
  HC ~ Ob, # obesity (BMI>30) relative contraindication for COC 
  Ca ~ Iinfl, # low grade inflammation -> cancer
  A ~ Ca, # cancer causes anemia
  A ~ Age, # due to iron requirements of growth younger women tend to be more iron deficient aas they have not yet requperated from growth. Should this be a "spline" ? 
 
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "IID" = 'Increased\niron\ndemand',
    "HC" = 'HC use\nand type',
    "Contr" = 'Contraindication\n for HC use',
    "RR" = 'Hypertension',
    "AE" = 'Arterial\nthrombosis',
    "VE" = 'Venous\nthrombosis',
    "AEVE" = 'Thrombosis/\nembolism',
    "Migr" = 'Aural\nmigraine',
    "DI" = 'Drug\ninteractions',
    "Tera" = 'Use of\nteratogens',
    "MBO" = 'MBO',
    "Ca" = 'Cancer',
    "Ob" = 'Obesity',
    "PALM" = 'PALM',
    "COEIN" = 'COEIN',
    "Ab" = 'Abortion',
    "MC" = 'Miscarriage',
    "ED" = 'Eating\ndisorder',
    "Acne" = 'Acne',
    "IBD" = 'IBD',
    "hypth" = 'Hypo-\nthyroidism',
    "GBP" = 'Gastric\nbypass',
    "Smoking" = 'Smoking',
    "Exe" = 'Exercise',
    "Lac" = 'Lactation',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "Inc" = 'Income',
    "Edu" = 'Education\nlevel',
    "Res" = 'Place of\nresidence',
    "RelSt" = 'Relationship\nstatus',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
    "CD" = 'Celiac\ndisease',
    "HP" = 'H. Pylori',
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet',
   "Age" = 'Age',
   "AUB" = 'AUB'
   
  ),
  exposure = "HC",
  outcome = "A"
)


hc_dag.diag <- from_ggdag_2_diagrammer(HC_DAG)
render_graph(
  hc_dag.diag, 
#  layout="tree"
)
```

## HC and IDA DAG: adjustment set

Finally, we create the minimal DAG to calculate adjustment sets. 

Child birth and pregnancy create backdoor paths. Exclude all data prior to first pregnancy.
Use of hormonal contraception to treat excessive menstrual flow. Exclude persons with excessive menstrual flow.
Similarly cancer could cause all kinds of loops so all persons with cancer diagnosis are best excluded.

```{r}
HC_DAG_fin <- ggdag::dagify(
#  II ~ VD, # Low haem iron content (eg, from a vegetarian or vegan diet)
#  II ~ ConInh, # Concomitant consumption of inhibitors of iron absorption (eg, calcium or tea)
#  II ~ InAcid, # Inadequate acidification
#  II ~ InMyc, # Intestinal mycosal dysfunction
  II ~ Edu, # education level is associated with diet, such as vegan diet low in heam iron
  Inc ~ Edu, # education level is associated with income
  Res ~ Inc, # place of residence is associated with income level
  HC ~ Inc, # income affects ability to purchase HC
  A ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  A ~ IID, # increased iron demand can cause body iron stores to be depleted, if iron intake is inadequate
#  IID ~ Exe, # exercise causes iron demand
#  IID ~ Lac, # lactation increases iron demand
  A ~ Pre, # pregnancy increases iron demand
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
#  A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  A ~ HC, # our exposure to outcome question, HC influences IDA not only through decreased menstrual blood loss, but also though effect on hepcidin (estrogen pos associated, progesterone neg association), parhaps also other mechanisms?
  A ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  A ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  InLoss ~ IBD, # IBD causes GI blood loss
  Iinfl ~ IBD, # IBD causes inflammation
  Iinfl ~ Ob,
#  InMyc ~ IBD, # IBD causes intestinal dysfunction (through inflammation?)
#  InMyc ~ GBP, # gastric bypass, particularly Roux-en-Y, causes food to bypass duodenum.  
#  InMyc ~ CD, # celiac disease
#  InMyc ~ HP, # H. Pylori
  A ~ BD, # Blood donation can cause iron deficiency
#  BD ~ IS, # If you are low own iron you can't get to donate 
#  A ~ Cb, # childbirth affects iron stores
#  A ~ MC, # miscarriage affects iron stores
#  A ~ Ab, # abortion affects iron stores
#  Cb ~ Pre, 
#  Ab ~ Pre, 
#  MC ~ Pre, 
  Pre ~ HC, 
  Pre ~ Edu, # education level is associated with (age of first) pregnancy
#  Mens ~ IS, # Your iron store can influence your menstruation
  Mens ~ AUB, # heavy menstrual bleeding
  Mens ~ ED, # eating disorders effect on HPO axis
  II ~ ED, 
  Mens ~ hypth, # hypothyroidism effect on HPO axis and cause heavy menstrual bleeding (reduces SHBG (sex hormone binding globulin), and the reduction leads to greater estrogen exposure which can cause HMB)
  A ~ hypth, 
#  AUB ~ PALM, # structural causes for HMB
#  AUB ~ COEIN, # non-structural causes for HMB
  HC ~ Age, # age affect your choice of contraception, should there HC X age interaction (age >35 years relative contraindication for HC)
  HC ~ Edu, # education level affects the choice of HC
  HC ~ Res, # some regions may offer free HC for certain age groups
#  HC ~ RelSt, # relationship status associated with need for HC and type of it 
  HC ~ Contr, # contraindication for HC use
#  HC ~ Tera, # teratogens (tretinoin, lithium)
  HC ~ Ca, # previous breast cancer contraindication for HC
  HC ~ AUB, # PALM-COEIN
#  HC ~ Acne,
  HC ~ Smoking,
  AEVE ~ Smoking, # smoking risk factor for  thorombosis
  AEVE ~ RR, # hypertension is a risk factor for thrombosis and embolism
  Contr ~ RR, # uncontrolled hypertension (1yr exclusion after dx?)
  Contr ~ AEVE, # arterial thrombosis (-> exclude stroke, TIA, ACS, DVT, PE)
  AEVE ~ Ca, # cancer increases risk for thrombosis
  AEVE ~ A, #  IDA increases risk of venous thrombosis
#  Contr ~ Migr, # aural migraine
#  Contr ~ DI, # drug interactions (antiepileptics)
  Iinfl ~ Age, # the older you are the more inflamed you get, "spline"?
  Iinfl ~ MBO, # metabolic syndrome, DM1, DM2
  Iinfl ~ Smoking, 
  Iinfl ~ HC, # use of COC has been linked to higher CRP, on the other hand IUD users in Finland have lower inflammatory markers
  RR ~ Smoking,
  RR ~ Age,
  MBO ~ RR, 
  MBO ~ Ob, # obesity risk factor for MBO
  AUB ~ Ob, # obesity risk factor for HMB
  HC ~ Ob, # obesity (BMI>30) relative contraindication for COC 
  Ca ~ Iinfl, # low grade inflammation -> cancer
  A ~ Ca, # cancer causes anemia
  A ~ Age, # due to iron requirements of growth younger women tend to be more iron deficient aas they have not yet requperated from growth. Should this be a "spline" ? 
 
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "IID" = 'Increased\niron\ndemand',
    "HC" = 'HC use\nand type',
    "Contr" = 'Contraindication\n for HC use',
    "RR" = 'Hypertension',
    "AE" = 'Arterial\nthrombosis',
    "VE" = 'Venous\nthrombosis',
    "AEVE" = 'Thrombosis/\nembolism',
    "Migr" = 'Aural\nmigraine',
    "DI" = 'Drug\ninteractions',
    "Tera" = 'Use of\nteratogens',
    "MBO" = 'MBO',
    "Ca" = 'Cancer',
    "Ob" = 'Obesity',
    "PALM" = 'PALM',
    "COEIN" = 'COEIN',
    "Ab" = 'Abortion',
    "MC" = 'Miscarriage',
    "ED" = 'Eating\ndisorder',
    "Acne" = 'Acne',
    "IBD" = 'IBD',
    "hypth" = 'Hypo-\nthyroidism',
    "GBP" = 'Gastric\nbypass',
    "Smoking" = 'Smoking',
    "Exe" = 'Exercise',
    "Lac" = 'Lactation',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "Inc" = 'Income',
    "Edu" = 'Education\nlevel',
    "Res" = 'Place of\nresidence',
    "RelSt" = 'Relationship\nstatus',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
    "CD" = 'Celiac\ndisease',
    "HP" = 'H. Pylori',
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet',
   "Age" = 'Age',
   "AUB" = 'AUB'
   
  ),
  exposure = "HC",
  outcome = "A"
)

# tried to change node colours herem but this does not work? I wanted factors directly related to IDA to be a separate colour 
# pastricha_dag <- pastricha_dag %>% 
#    set_node_attrs(node = c("Age"), color = "pink")




hc_dag_fin.diag <- from_ggdag_2_diagrammer(HC_DAG_fin)
render_graph(
  hc_dag_fin.diag, 
#  layout="neato"
)
```

```{r}
latents(HC_DAG_fin) <- c("II", "IID",  "Iinfl", "InLoss", "BD")
exposures(HC_DAG_fin) <- c("HC")
outcomes(HC_DAG_fin) <- c("A")

```

Latent variables are not directly measured or observed in the data set (hidden or unobservable). They are used to represent underlying constructs or concepts that cannot be directly quantified, but might influence influence observed variables. Unobserved variables are those for which we lack measurements in the data set- They can be either latent or directly observable, we just lack the ability to measure them. In other words, latent variables represent underlying constructs we can't quantify, while unobserved variables can't be captured due to practical limitations. 

```{r}
ggdag_adjustment_set(HC_DAG_fin)
#how to define the latent variables to get the corract adjustement set
```
No way to block backdoor paths. The issue seems to be inflammation as well as the thrombosis/embolism pathways, so we need to exclude inflammatory conditions (as inflammation itself is latent) and thrombosis+embolism. 

```{r}
HC_DAG_fin <- ggdag::dagify(
#  II ~ VD, # Low haem iron content (eg, from a vegetarian or vegan diet)
#  II ~ ConInh, # Concomitant consumption of inhibitors of iron absorption (eg, calcium or tea)
#  II ~ InAcid, # Inadequate acidification
#  II ~ InMyc, # Intestinal mycosal dysfunction
  II ~ Edu, # education level is associated with diet, such as vegan diet low in heam iron
  Inc ~ Edu, # education level is associated with income
  Res ~ Inc, # place of residence is associated with income level
  HC ~ Inc, # income affects ability to purchase HC
  A ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  A ~ IID, # increased iron demand can cause body iron stores to be depleted, if iron intake is inadequate
#  IID ~ Exe, # exercise causes iron demand
#  IID ~ Lac, # lactation increases iron demand
  A ~ Pre, # pregnancy increases iron demand
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
#  A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  A ~ HC, # our exposure to outcome question, HC influences IDA not only through decreased menstrual blood loss, but also though effect on hepcidin (estrogen pos associated, progesterone neg association), parhaps also other mechanisms?
  A ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  A ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  InLoss ~ IBD, # IBD causes GI blood loss
#  Iinfl ~ IBD, # IBD causes inflammation
  Iinfl ~ Ob,
#  InMyc ~ IBD, # IBD causes intestinal dysfunction (through inflammation?)
#  InMyc ~ GBP, # gastric bypass, particularly Roux-en-Y, causes food to bypass duodenum.  
#  InMyc ~ CD, # celiac disease
#  InMyc ~ HP, # H. Pylori
  A ~ BD, # Blood donation can cause iron deficiency
#  BD ~ IS, # If you are low own iron you can't get to donate 
#  A ~ Cb, # childbirth affects iron stores
#  A ~ MC, # miscarriage affects iron stores
#  A ~ Ab, # abortion affects iron stores
#  Cb ~ Pre, 
#  Ab ~ Pre, 
#  MC ~ Pre, 
  Pre ~ HC, 
  Pre ~ Edu, # education level is associated with (age of first) pregnancy
#  Mens ~ IS, # Your iron store can influence your menstruation
  Mens ~ AUB, # heavy menstrual bleeding
  Mens ~ ED, # eating disorders effect on HPO axis
  II ~ ED, 
  Mens ~ hypth, # hypothyroidism effect on HPO axis and cause heavy menstrual bleeding (reduces SHBG (sex hormone binding globulin), and the reduction leads to greater estrogen exposure which can cause HMB)
  A ~ hypth, 
#  AUB ~ PALM, # structural causes for HMB
#  AUB ~ COEIN, # non-structural causes for HMB
  HC ~ Age, # age affect your choice of contraception, should there HC X age interaction (age >35 years relative contraindication for HC)
  HC ~ Edu, # education level affects the choice of HC
  HC ~ Res, # some regions may offer free HC for certain age groups
#  HC ~ RelSt, # relationship status associated with need for HC and type of it 
  HC ~ Contr, # contraindication for HC use
#  HC ~ Tera, # teratogens (tretinoin, lithium)
  HC ~ Ca, # previous breast cancer contraindication for HC
  HC ~ AUB, # PALM-COEIN
#  HC ~ Acne,
  HC ~ Smoking,
#  AEVE ~ Smoking, # smoking risk factor for  thorombosis
#  AEVE ~ RR, # hypertension is a risk factor for thrombosis and embolism
  Contr ~ RR, # uncontrolled hypertension (1yr exclusion after dx?)
#  Contr ~ AEVE, # arterial thrombosis (-> exclude stroke, TIA, ACS, DVT, PE)
#  AEVE ~ Ca, # cancer increases risk for thrombosis
#  AEVE ~ A, #  IDA increases risk of venous thrombosis
#  Contr ~ Migr, # aural migraine
#  Contr ~ DI, # drug interactions (antiepileptics)
#  Iinfl ~ Age, # the older you are the more inflamed you get, "spline"?
#  Iinfl ~ MBO, # metabolic syndrome, DM1, DM2
#  Iinfl ~ Smoking, 
#  Iinfl ~ HC, # use of COC has been linked to higher CRP, on the other hand IUD users in Finland have lower inflammatory markers
  RR ~ Smoking,
  RR ~ Age,
#  MBO ~ RR, 
#  MBO ~ Ob, # obesity risk factor for MBO
  AUB ~ Ob, # obesity risk factor for HMB
  HC ~ Ob, # obesity (BMI>30) relative contraindication for COC 
#  Ca ~ Iinfl, # low grade inflammation -> cancer
  A ~ Ca, # cancer causes anemia
  A ~ Age, # due to iron requirements of growth younger women tend to be more iron deficient aas they have not yet requperated from growth. Should this be a "spline" ? 
 
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "IID" = 'Increased\niron\ndemand',
    "HC" = 'HC use\nand type',
    "Contr" = 'Contraindication\n for HC use',
    "RR" = 'Hypertension',
    "AE" = 'Arterial\nthrombosis',
    "VE" = 'Venous\nthrombosis',
    "AEVE" = 'Thrombosis/\nembolism',
    "Migr" = 'Aural\nmigraine',
    "DI" = 'Drug\ninteractions',
    "Tera" = 'Use of\nteratogens',
    "MBO" = 'Metabolic\nsyndrome',
    "Ca" = 'Cancer',
    "Ob" = 'Obesity',
    "PALM" = 'PALM',
    "COEIN" = 'COEIN',
    "Ab" = 'Abortion',
    "MC" = 'Miscarriage',
    "ED" = 'Eating\ndisorder',
    "Acne" = 'Acne',
    "IBD" = 'IBD',
    "hypth" = 'Hypo-\nthyroidism',
    "GBP" = 'Gastric\nbypass',
    "Smoking" = 'Smoking',
    "Exe" = 'Exercise',
    "Lac" = 'Lactation',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "Inc" = 'Income',
    "Edu" = 'Education\nlevel',
    "Res" = 'Place of\nresidence',
    "RelSt" = 'Relationship\nstatus',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
    "CD" = 'Celiac\ndisease',
    "HP" = 'H. Pylori',
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet',
   "Age" = 'Age',
   "AUB" = 'AUB'
   
  ),
  exposure = "HC",
  outcome = "A"
)

# tried to change node colours herem but this does not work? I wanted factors directly related to IDA to be a separate colour 
# pastricha_dag <- pastricha_dag %>% 
#    set_node_attrs(node = c("Age"), color = "pink")




hc_dag_fin.diag <- from_ggdag_2_diagrammer(HC_DAG_fin)
render_graph(
  hc_dag_fin.diag, 
#  layout="neato"
)
```

```{r}
latents(HC_DAG_fin) <- c("II", "IID", "InLoss", "BD", "Pre", "Iinfl")
exposures(HC_DAG_fin) <- c("HC")
outcomes(HC_DAG_fin) <- c("A")

```


```{r}
ggdag_adjustment_set(HC_DAG_fin)
#how to define the latent variables to get the correct adjustement set
```

```{r}
ggdag_instrumental(HC_DAG_fin)
```
## Coloring pathways

Possible attributes to set:

```{r}
get_global_graph_attr_info(hc_dag_fin.diag)
```


```{r}
get_node_df(hc_dag_fin.diag)
```

You can add arbitrary columns to node_df and set plotting attributes based on them. 

```{r}
# start by adding border colors
g1 <-
  hc_dag_fin.diag %>%
  set_node_attrs(
    node_attr = color,
    values = "#FA92B1",
    nodes = c(1)) %>% # you can add nodes within the bracket, separate with ,
  set_node_attrs(
    node_attr = color,
    values = "#D0E69E",
    nodes = c(9)) %>%
  set_node_attrs(
    node_attr = color,
    values = "#D0D8E9",
    nodes = c(2,3,4,5,6,7,8,10,11,12,13,14,15,16,17,18,19,20,21,22)) 

render_graph(
  g1, 
)

```


```{r}
# fill node 
g2 <-
  g1 %>%
  set_node_attrs(
    node_attr = fillcolor,
    values = "#ED0000FF", # this makes text white 
    nodes = c(1)) %>%  # outcome
    set_node_attrs(
    node_attr = fontcolor,
    values = "black") %>% 
  set_node_attrs(
    node_attr = fillcolor,
    values = "#42B540FF", 
    nodes = c(9)) %>%  # exposure 
    set_node_attrs(
    node_attr = fontcolor,
    values = "black") %>% 
  set_node_attrs(
    node_attr = fillcolor,
    values = "#00468BFF", 
    nodes = c(3,20)) %>%  # matching criteria 
    set_node_attrs(
    node_attr = fontcolor,
    values = "black") %>% 
  set_node_attrs(
    node_attr = fillcolor,
    values = "#0099B4FF", 
    nodes = c(2,5,8,10,15,17,18,22)) %>%  # model adjustment 
    set_node_attrs(
    node_attr = fontcolor,
    values = "black") %>% 
  set_node_attrs(
    node_attr = fillcolor,
    values = "#925E9FFF", 
    nodes = c(11,12,13,14)) %>%   # latents (latent variables represent underlying constructs we can't quantify) 
    set_node_attrs(
    node_attr = fontcolor,
    values = "black") %>% 
  set_node_attrs(
    node_attr = fillcolor,
    values = "#FDAF91FF", 
    nodes = c(4,6,16,19,21)) %>%   # unobserved (unobserved variables can't be captured due to practical limitations) 
    set_node_attrs(
    node_attr = fontcolor,
    values = "black") 
    


render_graph(
  g2, 
)

```



```{r}
get_edge_df(g2)
```



```{r}
# color arrows, specify start and end nodes
g3 <-
  g2 %>%
  DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = color,
    values = "#D0D8E9" # not specifying nodes makes all arrows the chosen color
  ) %>%
  DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = color,
    values = "#D0E69E", 
    from = 9,
    to =1
  ) %>%   DiagrammeR::set_edge_attrs( # igraph has the same function, so you need to specify
    edge_attr = arrowsize,
    values = 2, 
    from = 9,
    to =1
  )

render_graph(
  g3, 
)

```



```{r}
g4 <-
  g3 %>%
  DiagrammeR::set_edge_attrs( 
    edge_attr = fontsize, values = 8
  )

render_graph(
  g4, 
)
```



## Exclusion criteria 

Inflammation in Obesity, Diabetes and related Disorders (Rohm et al., DOI 10.1016/j.immuni.2021.12.013): Obesity, metabolic syndrome, DM2, IBD and rheumatoid arthritis all important causes or drivers of inflammation. Note that the exclusion list is not a comprehensive list of all causes of inflammation; rather inflammatory conditions that are common on a whole population basis in premenopausal women. Exclude these diagnosis for 12 months after diagnosis.
- E10 DM1
- E11 DM2
- E66 obesity and metabolic syndrome
- K50 and K51 IBD
- M05 & M06 Rheumatic diseases - likely not available as ICD, but we could use Kela reimbursment code 202 / prescription data  

Thrombosis and embolism: exclude all cases
- I80 DVT
- I81 portal thrombosis
- I82 other venous thrombosis (parhaps only I82.88?)
- O22.3 + O87.1 DVT in/after pregnancy
- I21 STEMI/NSTEMI/ACS (+R07 chest pain?)
- I26 PE
- 163 stroke 
- G45 TIA 

Cancer: exclude all breast cancer diagnosis (due to also being absolute contraindication for COC use), and any other cancer diagnosis is excluded for diagnosis within the past 5 years. Use cancer registry, not ICD codes. 

## Adjustment (separate models)  
Inflammation (Obesity, metabolic syndrome, DM, IBD, rheumatoid arthritis, gout all important causes or drivers of inflammation) adjusted for diagnosis >= 12 months ago
- same as above

AUB: diagnosis of PALM-COEIN
- N80 endometriosis
- N84 polyps (does this need to be split into smaller groups?)
- N92 HMB (does this need to be split into smaller groups?)
- N93 other uterine/vaginal bleeding 

Age 
- Linear variable (categorical another option, ie age groups)

Education level
- Based on statistic, categorical variable

## Matching
- Age 
- Place of residence 


