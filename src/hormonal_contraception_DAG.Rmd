---
title: "DAG for anemia in FinOCC"
author: "Mikko Arvas"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DiagrammeR)
library(ggdag)
library(causaleffect)
library(igraph)
library(tidyverse)
library(dagitty)
```


# Functions

```{r}
from_ggdag_2_diagrammer <- function(ggdag.object) {
  tmp <- tidy_dagitty(ggdag.object)$data
 #tmp <- tidy_dagitty(anemia_dag)$data
  edges <- tmp %>% 
    select(name, to) %>% 
    rename("from"="name") %>% 
    na.omit()
  
   nodes <- tmp %>% 
   select(name,label) %>%
   #  select(name) %>% 
   rename("id"="name") %>%
   distinct() %>%
   na.omit()
  g <- create_graph(
    directed = TRUE,
    attr_theme = "tb"
  )
  g<- add_nodes_from_table(g,
                           table = nodes,
                           label_col = label)
  g <- add_edges_from_table(graph =g,
                            table=edges,
                            from_col = from,
                            to_col = to,
                            from_to_map=id_external)
  invisible(g)
}

```


```{r}
from_ggdag_2_igraph <- function(dagify.object) {
  tmp <- tidy_dagitty(dagify.object)$data
  tmp <- tmp %>% select(name, to) %>% 
  as.matrix() %>% # igraph wants a matrix
  na.omit() #there was A -> NA , maybe to spesify outcome
  tmp <- graph_from_edgelist(tmp, directed = TRUE)
  invisible(tmp)
}

```


# Pastricha DAG with hormonal contraception

Based on "Iron deficiency" 
Sant-Rayn Pasricha, Jason Tye-Din, Martina U Muckenthaler, Dorine W Swinkels 2021 Lancet
http://dx.doi.org/10.1016/S0140-6736(20)32594-0

```{r}

pastricha_dag <- ggdag::dagify(
  II ~ VD, # Low haem iron content (eg, from a vegetarian or vegan diet)
  II ~ ConInh, # Concomitant consumption of inhibitors of iron absorption (eg, calcium or tea)
  II ~ InAcid, # Inadequate acidification
  II ~ InMyc, # Intestinal mycosal dysfunction
  IS ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
  A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  IS ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  IS ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  IS ~ BD,
  IS ~ Cb,
  Cb ~ Pre,
  
  
  
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "HC" = 'Use/Choise\nof HC',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
   "Erosion" = "Erosion",
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet'
   
  ),
  exposure = "HC",
  outcome = "A"
)

pastricha_dag.diag <- from_ggdag_2_diagrammer(pastricha_dag)
render_graph(
  pastricha_dag.diag, 
#  layout="tree"
)
```

```{r}
latents(pastricha_dag) <- c("II","IS")
exposures(pastricha_dag) <- c("HC")
outcomes(pastricha_dag) <- c("A")

```


```{r}
ggdag_adjustment_set(pastricha_dag)
#how to define the latent variables to get the corract adjustement set
```

‘Backdoor Paths Unconditionally Closed’ means that, assuming the DAG we have drawn is correct, we may obtain an unbiased estimate of X on Y without including additional variables.

```{r}
ggdag_instrumental(pastricha_dag)
```

# Pastricha DAG with added complexity


```{r}
pastricha_dag_mens <- ggdag::dagify(
  II ~ VD, # Low haem iron content (eg, from a vegetarian or vegan diet)
  II ~ ConInh, # Concomitant consumption of inhibitors of iron absorption (eg, calcium or tea)
  II ~ InAcid, # Inadequate acidification
  II ~ InMyc, # Intestinal mycosal dysfunction
  IS ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
  A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  IS ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  IS ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  IS ~ BD,
  IS ~ Cb,
  Cb ~ Pre,
  Mens ~ IS, # Your iron store can influence your menstruation
  HC ~ Mens, # Your menstruation can influece you choise of HC
  HC ~ Iinfl, # obesity and mentabolic disease can influence your choise of HC
  HC ~ Cb, # having kids will impact on you choice of hormonal contraception
  
  
  
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "HC" = 'Use/Choise\nof HC',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
   "Erosion" = "Erosion",
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet'
   
  ),
  exposure = "HC",
  outcome = "A"
)

pastricha_dag.diag <- from_ggdag_2_diagrammer(pastricha_dag_mens)
render_graph(
  pastricha_dag.diag, 
#  layout="tree"
)
```


```{r}
latents(pastricha_dag_mens) <- c("II","IS")
exposures(pastricha_dag_mens) <- c("HC")
outcomes(pastricha_dag_mens) <- c("A")

```


```{r}
ggdag_adjustment_set(pastricha_dag_mens)
#how to define the latent variables to get the corract adjustement set
```




```{r}
ggdag_instrumental(pastricha_dag_mens)
```

# Pastricha DAG with added complexity and exclusions

Child birth and pregnancy create backdoor paths. Exclude all data prior to first pregnancy.
Use of hormonal contraception to treat excessive menstrual flow. Exclude persons with excessive menstrual flow.
Similarly cancer could cause all kinds of loops so all persons with cancer diagnosis are best excluded.

```{r}
pastricha_dag_mens_no <- ggdag::dagify(
  II ~ VD, # Low haem iron content (eg, from a vegetarian or vegan diet)
  II ~ ConInh, # Concomitant consumption of inhibitors of iron absorption (eg, calcium or tea)
  II ~ InAcid, # Inadequate acidification
  II ~ InMyc, # Intestinal mycosal dysfunction
  IS ~ II, #When iron intake is inadequate to meet requirements or to compensate for physiological or pathological losses, body iron stores become depleted
  A ~ Iinfl, #In patients with inflammation, withholding of iron from the plasma promotes iron deficient erythropoiesis and anaemia despite adequate body iron stores (functional iron deficiency). Obesity
  A ~ IS, # Absolute ID occurs when iron stores are insufficient to meet the needs of the individual, and is particularly common in young children (younger than 5 years) and premenopausal (especially pregnant) women
  IS ~ Mens,  # The main causes of absolute ID are excessive blood loss...
  Mens ~ HC,
  IS ~ InLoss,  # Gastrointestinal blood loss is the most important cause of ID in men and postmenopausal women
  IS ~ BD,
  Mens ~ IS, # Your iron store can influence your menstruation
  HC ~ Iinfl, # obesity and mentabolic disease can influence your choise of HC
 
  labels = c(
    "A" = 'Iron\ndeficiency\nanemia',
    "HC" = 'Use/Choise\nof HC',
    "Mens"= 'Menstruation' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child\nbirth' ,
    "II" = 'Iron\nintake',
    "IS" = 'Iron\nstores',
   "Iinfl" = 'Inflammation',
   "InLoss" = 'Gastrointestinal\nblood loss',
   "Erosion" = "Erosion",
   "CC" = 'Colon cancer',
   "InflBo" = 'Inflamatory bowel disease',
   "BD" = 'Blood\ndonation',
   "ConInh" = 'Consumption\nof inhibitors',
   "InMyc" = 'Intestinal\ndysfunction',
   "InAcid" = 'Inadequate\nacidification',
   "VD" = 'Low\niron\ndiet'
   
  ),
  exposure = "HC",
  outcome = "A"
)

pastricha_dag.diag <- from_ggdag_2_diagrammer(pastricha_dag_mens_no)
render_graph(
  pastricha_dag.diag, 
#  layout="tree"
)
```


```{r}
latents(pastricha_dag_mens_no) <- c("II","IS")
exposures(pastricha_dag_mens_no) <- c("HC")
outcomes(pastricha_dag_mens_no) <- c("A")

```


```{r}
ggdag_adjustment_set(pastricha_dag_mens_no)
```


```{r}
ggdag_instrumental(pastricha_dag_mens_no)
```
# Previous experiments


## Overall DAG

```{r}
#based on https://www.erikigelstrom.com/articles/causal-graphs-in-r-with-diagrammer/

grViz("
digraph {
  graph [ranksep = 0.2]

  node [shape = plaintext]
    A    [label = 'Anemia', shape = box]
    I    [label = 'Iron stores']

    HC  [label = 'Hormonal contraception', shape = box ]
    Mens [label = 'Menstruation' , shape = box]
    Pre  [label = 'Pregnancy' , shape = box]
    Cb  [label = 'Child birth' , shape = box]
    MS  [label = 'Metabolic syndrome' , shape = box]
    D   [label = 'Diet']
    IS  [label = 'Iron supplements']
    M   [label = 'Migraine', shape = box]
    Ag  [label = 'Age' , shape = box]
    B   [label = 'Blood donation', shape = box]
    O   [label = 'Overweight', shape = box ]
    S   [label = 'Smoking' , shape = box]
    Ac  [label = 'Acne' , shape = box]
    An  [label = 'Anorexia' , shape = box]
    PE  [label = 'Physical excercise']
    CI  [label = 'Other diagnoses?' , shape = box]
    C   [label = 'Cancer' shape = box]
    
    
    #SEP  [label = 'Socioeconomic position', shape = box]

  edge [minlen = 2]
    I->A
    Mens->I
    HC->Mens #HC will reduce menstrual flow
    Mens -> HC # If you have excessive menstrual flow you are more likely to be recommended HC
    Mens -> Pre
    HC->Pre
    Cb -> HC
    Pre->I
    Pre->Cb
    Cb->I
    D->I
    IS->I
    M->HC
    MS->A # Overweight (and smoking?) cause IDA 
    MS -> HC # 'The risk of ischemic stroke in patients using combined oral contraceptives is increased in patients with additional stroke risk factors, including smoking, hypertension, and migraine with aura'

    Ag -> HC
  #  O -> A
    O -> MS
    B -> I
    S -> MS
    S -> HC
    Ac -> HC
    D -> An
    An -> Mens
    PE -> Mens
    PE -> I
    C -> A
    HC -> A

{ 
  rank = same; I; A
#  rank = same; CI; MS
  }
}
")
```
Which diagnoses before anemia diagnoses are bases for exclusion?

  -Everything we use as basis of exclusion, we don't have to worry about.

What else could impact on the choice of hormonal contraception?

Should "Diet" have a direct arrow to menstruation?

Should "Age" have a direct arrow to menstruation?

Should we separate combined oral contraceptive pill and  progesterone only analysis?





## DAG of what we have in FinOCC

```{r}

anemia_dag <- ggdag::dagify(
  HC ~  Mens, # If you have excessive menstrual flow you are more likely to be recommended HC
  Mens ~ HC, # If you have HC you won't have menstruation/excessive menstrual flow
  Mens ~ An , # Anorexia can stop excessive menstrual flow
  A ~ Mens , # menstruation/excessive menstrual flow can cause anemia
  Pre ~ HC, # HC will block pregnancy
  HC ~ Pre, # Pregnancy can affect your use/choise of HC
  HC ~ Cb , # Cb can affect your use/choise of HC
  Cb ~ Pre, #Pregnancy can cause child birth
  A ~ Cb, # Child birth can cause anemia
  HC ~ M , #Migraine can effect choise of HC
  A ~ MS  , # Obesity can cause IDA 
  HC ~ MS, # 'The risk of ischemic stroke in patients using combined oral contraceptives is increased in patients with additional stroke risk factors, including smoking, hypertension, and migraine with aura'
  HC ~ Ag, # Age can affect your choise of HC
  Pre ~ Ag, # Age reduces your likely hood of getting pregnant
  MS ~ O  , # Obesity causes metabolic syndrome
  HC ~ Ac , # Acne can affect your choise of HC

  A ~ C, # cancer can cause anemia
  A ~ HC, # hormonal contraception can protect from anemia, but should this go only through the menstruation variable?
  labels = c(
    "A" = 'Anemia',
    "HC" = 'Use/Choise of HC',
    "Mens"= 'Ex. mens. flow' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child birth' ,
    "MS" = 'Metabolic syndrome' ,
    "M" =  'Migraine',
    "Ag" = 'Age' ,
    "O"  = 'Obesity',
    "Ac"  = 'Acne' ,
    "An" = 'Anorexia',
    "C" = 'Cancer'
  ),
  exposure = "HC",
  outcome = "A"
)

ggdag::ggdag(anemia_dag, # the dag object we created
             text = FALSE, # this means the original names won't be shown
             use_labels = "label") #+ # instead use the new names
```

```{r}

tidy_dagitty(anemia_dag)

```

### Plot with diagrammeR

```{r}



g <- from_ggdag_2_diagrammer(anemia_dag)


```

Can I then the DiagrammeR to plot the graph and extract co-ordinates from it to make the ggdag look better?


```{r}
render_graph(
  g, 
#  layout="tree"
)
```


```{r}
#grViz(g)
```


```{r}
adag.tibble <- tidy_dagitty(anemia_dag)$data
colnames(adag.tibble)
```
```{r}

adag.tibble %>% select(name, direction, to) %>% summary()

```



```{r}
ggdag_paths(anemia_dag)
```

```{r}
ggdag_adjustment_set(anemia_dag)
```


Excessive menstrual flow will cause a loop that needs to be blocked. How?
  -Exclude all persons with excessive menstrual flow diagnosis ?
  -Similarly cancer could cause all kinds of loops so all persons with cancer diagnosis are best excluded
  
  

```{r}

anemia_01_dag <- ggdag::dagify(
  #HC ~  Mens, # If you have excessive menstrual flow you are more likely to be recommended HC
  #Mens ~ HC, # If you have HC you won't have excessive menstrual flow
  Pre ~ HC, # HC will block pregnancy
  HC ~ Pre, # Pregnancy can affect your use/choise of HC
  HC ~ Cb , # Cb can affect your use/choise of HC
  Cb ~ Pre, #Pregnancy can cause child birth
  A ~ Cb, # Child birth can cause anemia
  HC ~ M , #Migraine can effect choise of HC
  A ~ MS  , # Obesity can cause IDA 
  #A ~ Mens , # Excessive menstrual flow can cause anemia
  HC ~ MS, # 'The risk of ischemic stroke in patients using combined oral contraceptives is increased in patients with additional stroke risk factors, including smoking, hypertension, and migraine with aura'
  HC ~ Ag, # Age can affect your choise of HC
  Pre ~ Ag, # Age reduces your likely hood of getting pregnant
  MS ~ O  , # Obesity causes metabolic syndrome
  HC ~ Ac , # Acne can affect your choise of HC
#  Mens ~ An , # Anorexia can stop excessive menstrual flow
#  A ~ C,
  A ~ HC,
  labels = c(
    "A" = 'Anemia',
    "HC" = 'Use/Choise of HC',
    "Mens"= 'Ex. mens. flow' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child birth' ,
    "MS" = 'Metabolic syndrome' ,
    "M" =  'Migraine',
    "Ag" = 'Age' ,
    "O"  = 'Obesity',
    "Ac"  = 'Acne' ,
    "An" = 'Anorexia',
    "C" = 'Cancer'
  ),
  exposure = "HC",
  outcome = "A"
)

ggdag::ggdag(anemia_dag, # the dag object we created
             text = FALSE, # this means the original names won't be shown
             use_labels = "label") #+ # instead use the new names
```

```{r}
ggdag_paths(anemia_01_dag)
```

```{r}
ggdag_adjustment_set(anemia_01_dag)
```



```{r}
anemia_02_dag <- ggdag::dagify(
  #HC ~  Mens, # If you have excessive menstrual flow you are more likely to be recommended HC
  #Mens ~ HC, # If you have HC you won't have excessive menstrual flow
  #Pre ~ HC, # HC will block pregnancy
  #HC ~ Pre, # Pregnancy can affect your use/choise of HC
  #HC ~ Cb , # Cb can affect your use/choise of HC
  #Cb ~ Pre, #Pregnancy can cause child birth
  #A ~ Cb, # Child birth can cause anemia
  HC ~ M , #Migraine can effect choise of HC
  A ~ MS  , # Obesity can cause IDA 
  #A ~ Mens , # Excessive menstrual flow can cause anemia
  HC ~ MS, # 'The risk of ischemic stroke in patients using combined oral contraceptives is increased in patients with additional stroke risk factors, including smoking, hypertension, and migraine with aura'
  HC ~ Ag, # Age can affect your choise of HC
  #Pre ~ Ag, # Age reduces your likely hood of getting pregnant
  MS ~ O  , # Obesity causes metabolic syndrome
  HC ~ Ac , # Acne can affect your choise of HC
#  Mens ~ An , # Anorexia can stop excessive menstrual flow
#  A ~ C,
  A ~ HC,
  labels = c(
    "A" = 'Anemia',
    "HC" = 'Use/Choise of HC',
    "Mens"= 'Ex. mens. flow' ,
    "Pre" = 'Pregnancy' ,
    "Cb" = 'Child birth' ,
    "MS" = 'Metabolic syndrome' ,
    "M" =  'Migraine',
    "Ag" = 'Age' ,
    "O"  = 'Obesity',
    "Ac"  = 'Acne' ,
    "An" = 'Anorexia',
    "C" = 'Cancer'
  ),
  exposure = "HC",
  outcome = "A"
)

ggdag::ggdag(anemia_02_dag, # the dag object we created
             text = FALSE, # this means the original names won't be shown
             use_labels = "label") #+ # instead use the new names
```

```{r}
ggdag_paths(anemia_02_dag)
```

```{r}
ggdag_adjustment_set(anemia_02_dag)
```



Hence, the model would be:

A ~  hormonal_contraception + metabolic_syndrome

But what do we do with age? Based on FinDonor it could be considered causal for anemia. Based on PBAC it could be a proxy to menstruation. It needs to be accounted for? Do we just make models with and without it as it also influences choise of HC ? Or can we consider some age group where choise of HC would not be impacted by age??? This needs experimentation on the DAG.

Do we want to make an analysis plan and submit it before analysis!?


## causaleffect experiments



```{r}

g <- from_ggdag_2_igraph(anemia_dag)
l <- layout_with_sugiyama(g)
# plot
plot(g, layout=-l$layout[,2:1], edge.arrow.size = 0.4)
```

```{r}

#ce1 <- causal.effect(y = "A", x = "HC", z = NULL, G = g, expr = TRUE)

# Error in `causal.effect()`:
# ! Graph 'G' is not a DAG
# Backtrace:
#  1. causaleffect::causal.effect(...)
# Execution halted

```

```{r}

g <- from_ggdag_2_igraph(anemia_02_dag)
l <- layout_with_sugiyama(g)
# plot
plot(g, layout=-l$layout[,2:1], edge.arrow.size = 0.4)

```

```{r}

ce1 <- causal.effect(y = "A", x = "HC", z = NULL, G = g, expr = TRUE)
ce1
```

And what does that mean?


Would this be better?

1. create graph with https://rich-iannone.github.io/DiagrammeR/reference/create_graph.html

2. display it with grViz?

3. can graph from create graph be imported to ggdag

https://rdrr.io/cran/DiagrammeR/man/from_igraph.html

try to plot with Diagrammer the ggdag object
